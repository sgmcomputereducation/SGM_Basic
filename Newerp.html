<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGM Computer Education • ERP</title>
  <meta name="description" content="SGM ERP - Enquiry, Student, Admission, Receipt, EMI, Batch, Attendance, Exam, Completion, Certificate, Verify" />
  <link rel="icon" href="https://www.sgmcomputereducation.com/favicon.ico">

  <!-- Bootstrap (UI) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f6fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --brand1:#0b3d91; --brand2:#0ea5e9; --line:#e5e7eb;
      --shadow:0 12px 30px rgba(2, 6, 23, .10);
      --radius:16px;
    }
    body{ background:var(--bg); color:var(--ink); }
    .topbar{
      background: linear-gradient(90deg, var(--brand1), #1d4ed8);
      color:#fff; padding:14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.15);
    }
    .brand-badge{
      width:44px;height:44px;border-radius:12px;
      background:rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
    }
    .layout{ display:grid; grid-template-columns: 310px 1fr; gap:16px; padding:16px; }
    @media (max-width: 992px){ .layout{ grid-template-columns: 1fr; } }
    .panel{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      border:1px solid var(--line);
    }
    .left{ padding:14px; }
    .right{ padding:14px; }
    .menu-group{ margin-top:10px; }
    .menu-title{ font-size:12px; color:var(--muted); letter-spacing:.12em; text-transform:uppercase; margin:14px 8px 6px; }
    .menu-btn{
      width:100%; text-align:left; border:1px solid transparent; border-radius:12px;
      padding:10px 12px; display:flex; align-items:center; gap:10px;
      background:transparent; color:var(--ink);
    }
    .menu-btn:hover{ background:#f1f5ff; border-color:#dbeafe; }
    .menu-btn.active{ background:#eef2ff; border-color:#c7d2fe; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; background:#eff6ff; color:#1e40af;
      border:1px solid #dbeafe; font-size:12px;
    }
    .toastbox{
      position:fixed; right:16px; bottom:16px; width:360px; max-width: calc(100% - 32px); z-index:9999;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .smallmuted{ color:var(--muted); font-size:12px; }
    .form-grid{
      display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;
    }
    @media (max-width: 992px){ .form-grid{ grid-template-columns: 1fr; } }
    .kv-table td,.kv-table th{ font-size:12px; padding:8px; }
    .table-wrap{ max-height: 420px; overflow:auto; border:1px solid var(--line); border-radius:12px; }
    .sticky-top-2{ position:sticky; top:0; background:var(--card); z-index:2; }
    .badge-soft{
      border:1px solid var(--line); background:#fff; color:var(--muted);
      padding:6px 10px; border-radius:999px; font-size:12px;
    }
    .fee-badge{ font-weight:700; }
    .fee-red{ background:#fff1f2; border-color:#fecdd3; color:#9f1239; }
    .fee-amber{ background:#fffbeb; border-color:#fde68a; color:#92400e; }
    .fee-green{ background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .loading-scrim{
      position:fixed; inset:0; background:rgba(2,6,23,.30);
      display:none; align-items:center; justify-content:center; z-index:9998;
      backdrop-filter: blur(4px);
    }
    .loading-scrim.show{ display:flex; }
  </style>
</head>

<body>
  <!-- Top Branding -->
  <div class="topbar">
    <div class="container-fluid">
      <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
        <div class="d-flex align-items-center gap-3">
          <div class="brand-badge"><i class="bi bi-mortarboard-fill fs-4"></i></div>
          <div>
            <div class="fw-bold" style="line-height:1.1;">SGM COMPUTER EDUCATION</div>
            <div style="font-size:12px; opacity:.9; line-height:1.2;">
              Registered Under MSME | ISO 9001-2015 Certified Center
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="pill"><i class="bi bi-telephone-fill"></i> 9742266359</span>
          <span class="pill"><i class="bi bi-whatsapp"></i> WhatsApp</span>
          <span class="pill"><i class="bi bi-envelope-fill"></i> info@sgmcomputereducation.com</span>
          <span class="pill"><i class="bi bi-globe2"></i> sgmcomputereducation.com</span>
        </div>
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- Left Menu -->
    <div class="panel left">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="fw-bold">ERP Menu</div>
          <div class="smallmuted">Single-file SPA • Schema auto-forms • JSONP compatible</div>
        </div>
        <span id="rolePill" class="pill">ROLE: ADMIN</span>
      </div>

      <hr>

      <div class="menu-group">
        <div class="menu-title">Dashboard</div>
        <button class="menu-btn active" data-page="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</button>

        <div class="menu-title">Leads & Students</div>
        <button class="menu-btn" data-page="enquiry"><i class="bi bi-chat-dots"></i> Enquiry</button>
        <button class="menu-btn" data-page="student"><i class="bi bi-person-badge"></i> Student</button>
        <button class="menu-btn" data-page="admission"><i class="bi bi-journal-check"></i> Admission</button>

        <div class="menu-title">Fees</div>
        <button class="menu-btn" data-page="receipt"><i class="bi bi-receipt"></i> Receipt</button>
        <button class="menu-btn" data-page="emi"><i class="bi bi-calendar2-week"></i> EMI / Fee Balance</button>

        <div class="menu-title">Batch & Training</div>
        <button class="menu-btn" data-page="batch"><i class="bi bi-people"></i> Batch</button>
        <button class="menu-btn" data-page="batchalloc"><i class="bi bi-diagram-3"></i> Batch Allocation</button>
        <button class="menu-btn" data-page="attendance"><i class="bi bi-check2-square"></i> Attendance</button>

        <div class="menu-title">Assessment</div>
        <button class="menu-btn" data-page="exam"><i class="bi bi-clipboard-data"></i> Exam</button>
        <button class="menu-btn" data-page="completion"><i class="bi bi-award"></i> Course Completion</button>

        <div class="menu-title">Certificates</div>
        <button class="menu-btn" data-page="certapp"><i class="bi bi-file-earmark-text"></i> Certificate Application</button>
        <button class="menu-btn" data-page="certissued"><i class="bi bi-patch-check"></i> Certificate Issued</button>
        <button class="menu-btn" data-page="verify"><i class="bi bi-shield-check"></i> Verify Certificate</button>

        <hr>
        <div class="d-flex gap-2">
          <button id="btnTheme" class="btn btn-outline-dark w-50"><i class="bi bi-moon-stars"></i> Theme</button>
          <button id="btnLogout" class="btn btn-outline-secondary w-50"><i class="bi bi-box-arrow-right"></i> Logout</button>
        </div>

        <div class="mt-3 smallmuted">
          <div><b>Backend:</b> <span class="mono" id="backendUrlTxt"></span></div>
          <div><b>Mode:</b> <span id="modeTxt"></span></div>
        </div>
      </div>
    </div>

    <!-- Right Content -->
    <div class="panel right">
      <!-- Header actions -->
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <div class="fw-bold fs-5" id="pageTitle">Dashboard</div>
          <div class="smallmuted" id="pageSub">Stats • Quick actions • Search</div>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="input-group" style="min-width: 320px;">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="globalQ" class="form-control" placeholder="Global Search (Enquiry/Student/Admission/Receipt/...)" />
            <button id="btnGlobalSearch" class="btn btn-primary">Search</button>
          </div>

          <button id="btnRefresh" class="btn btn-outline-primary"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
          <button id="btnNew" class="btn btn-outline-secondary"><i class="bi bi-plus-lg"></i> New</button>
          <button id="btnSave" class="btn btn-success"><i class="bi bi-save2"></i> Save</button>
          <button id="btnPdf" class="btn btn-outline-dark"><i class="bi bi-filetype-pdf"></i> PDF</button>
        </div>
      </div>

      <hr>

      <!-- Content grid -->
      <div class="row g-3">
        <div class="col-lg-7">
          <div class="p-3" style="border:1px solid var(--line); border-radius: var(--radius); background:#fff; box-shadow: var(--shadow);">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-bold" id="formTitle">Loading...</div>
                <div class="smallmuted" id="formHint">Connecting to backend & schema...</div>
              </div>
              <div class="d-flex gap-2">
                <span class="badge-soft" id="apiBadge">API: …</span>
                <span class="badge-soft" id="schemaBadge">Schema: …</span>
              </div>
            </div>

            <div class="mt-3" id="feeBox" style="display:none;"></div>
            <div class="mt-3 form-grid" id="formFields"></div>

            <div class="mt-3 smallmuted">
              <div><b>Primary Key:</b> <span class="mono" id="pkInfo">—</span></div>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="p-3" style="border:1px solid var(--line); border-radius: var(--radius); background:#fff; box-shadow: var(--shadow);">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-bold">Results</div>
                <div class="smallmuted">List view • click a row to load into form</div>
              </div>
              <div class="smallmuted" id="resultMeta"></div>
            </div>
            <div class="mt-3 table-wrap">
              <table class="table table-sm table-hover mb-0">
                <thead class="sticky-top-2">
                  <tr id="tblHead"></tr>
                </thead>
                <tbody id="tblBody"></tbody>
              </table>
            </div>
            <div class="smallmuted mt-2" id="tblNote"></div>
          </div>
        </div>
      </div>

      <!-- Dashboard / Global results -->
      <div class="mt-3" id="extraArea"></div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-scrim" id="scrim">
    <div class="panel p-4" style="min-width:320px; text-align:center;">
      <div class="spinner-border" role="status"></div>
      <div class="mt-3 fw-bold">Loading…</div>
      <div class="smallmuted" id="scrimTxt">Please wait</div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toastbox" id="toastbox"></div>

<script>
/** =========================================================
 * CONFIG
 * ========================================================= */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxy8Hsg63xBnyd1l43YPfRHaUiS-KwoMvocD3v33ALZh6un8im797QOqxh5CMvwNs4f/exec";

/** Module setup: sheet names must match your Google Sheet tab names */
const PAGES = {
  dashboard: { title:"Dashboard", module:"dashboard", action:"stats", method:"GET", pk:null, sheet:null },
  enquiry:   { title:"Enquiry", module:"enquiry",   sheet:"Enquiries", pk:"enquiryId" },
  student:   { title:"Student", module:"student",   sheet:"Students", pk:"studentId" },
  admission: { title:"Admission",module:"admission", sheet:"Admissions", pk:"admissionId" },

  receipt:   { title:"Receipt", module:"receipt",   sheet:"Receipts", pk:"receiptId" },
  emi:       { title:"EMI / Fee Balance", module:"emi", sheet:"EMI_Plan", pk:null },

  batch:     { title:"Batch", module:"batch", sheet:"Batches", pk:"batchId" },
  batchalloc:{ title:"Batch Allocation", module:"batch", action:"allocations", sheet:"BatchAllocations", pk:"allocationId" },
  attendance:{ title:"Attendance", module:"attendance", sheet:"Attendance", pk:"attendanceId" },

  exam:      { title:"Exam", module:"exam", sheet:"Exams", pk:"examId" },
  completion:{ title:"Course Completion", module:"completion", sheet:"CourseCompletion", pk:"completionId" },

  certapp:   { title:"Certificate Application", module:"certificate", sheet:"Certificate_Applications", pk:"applicationId" },
  certissued:{ title:"Certificate Issued", module:"certificate", sheet:"Certificates_Issued", pk:"certificateId" },
  verify:    { title:"Verify Certificate", module:"verify", action:"certificate", sheet:null, pk:null }
};

/** =========================================================
 * STATE
 * ========================================================= */
let currentPage = "dashboard";
let schemaCache = {};     // sheet -> headers
let currentHeaders = [];  // active headers
let currentPk = null;
let currentRow = {};      // current form values
let lastList = [];        // current result list objects

/** detect runtime (important!) */
const IS_FILE = location.protocol === "file:";
const IS_HTTPS = location.protocol === "https:";
const MODE = (IS_FILE ? "file://" : "web");
document.getElementById("backendUrlTxt").textContent = WEBAPP_URL;
document.getElementById("modeTxt").textContent = MODE + (IS_FILE ? " (WARNING: host on https to avoid errors)" : "");

/** =========================================================
 * UI helpers
 * ========================================================= */
function toast(type, title, msg){
  const id = "t" + Math.random().toString(16).slice(2);
  const icon = type==="ok" ? "bi-check-circle" : (type==="warn" ? "bi-exclamation-triangle" : "bi-x-circle");
  const border = type==="ok" ? "border-success" : (type==="warn" ? "border-warning" : "border-danger");
  const html = `
    <div id="${id}" class="panel p-3 mb-2 ${border}" style="background:#fff;">
      <div class="d-flex align-items-start justify-content-between gap-2">
        <div>
          <div class="fw-bold"><i class="bi ${icon}"></i> ${escapeHtml(title)}</div>
          <div class="smallmuted mt-1">${escapeHtml(msg)}</div>
        </div>
        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('${id}').remove()"><i class="bi bi-x"></i></button>
      </div>
    </div>`;
  document.getElementById("toastbox").insertAdjacentHTML("afterbegin", html);
  setTimeout(()=>{ const el=document.getElementById(id); if(el) el.remove(); }, 6500);
}
function scrim(show, text){
  const el = document.getElementById("scrim");
  document.getElementById("scrimTxt").textContent = text || "Please wait";
  el.classList.toggle("show", !!show);
}
function escapeHtml(s){
  return String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** =========================================================
 * API: JSONP (works without CORS)
 * ========================================================= */
function jsonp(url, timeoutMs=20000){
  return new Promise((resolve, reject)=>{
    const cb = "__cb_" + Math.random().toString(16).slice(2);
    const s = document.createElement("script");
    const t = setTimeout(()=>{
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      try { delete window[cb]; } catch(e){ window[cb]=undefined; }
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };

    const sep = url.includes("?") ? "&" : "?";
    s.src = url + sep + "callback=" + encodeURIComponent(cb) + "&_ts=" + Date.now();
    s.onerror = ()=>{
      cleanup();
      reject(new Error("JSONP network error"));
    };
    document.body.appendChild(s);
  });
}

/** Build URL with params */
function buildUrl(params){
  const u = new URL(WEBAPP_URL);
  Object.entries(params||{}).forEach(([k,v])=>{
    if(v===undefined || v===null || v==="") return;
    u.searchParams.set(k, v);
  });
  return u.toString();
}

/** Always use JSONP in cross-origin scenarios (GitHub Pages, Google Sites, file://) */
async function apiGet(params){
  const url = buildUrl(params);
  // Using JSONP avoids CORS completely.
  return await jsonp(url);
}

/** =========================================================
 * Schema load
 * ========================================================= */
async function loadSchema(sheetName){
  if(!sheetName) return [];
  if(schemaCache[sheetName]) return schemaCache[sheetName];

  const res = await apiGet({ module:"schema", action:"sheet", sheet: sheetName });
  if(!res || !res.ok) throw new Error(res?.error || "Schema failed");

  const headers = Array.isArray(res.headers) ? res.headers : [];
  schemaCache[sheetName] = headers;

  document.getElementById("schemaBadge").textContent = headers.length ? ("Schema: OK ("+headers.length+")") : "Schema: EMPTY";
  return headers;
}

/** =========================================================
 * Form rendering
 * ========================================================= */
function guessType(field){
  const lk = field.toLowerCase();
  if(lk.includes("date") && !lk.includes("datetime")) return "date";
  if(lk.includes("datetime") || lk.includes("timestamp")) return "datetime-local";
  if(lk.includes("amount") || lk.includes("fee") || lk.includes("price") || lk.includes("marks") || lk.includes("score") || lk.includes("months") || lk.includes("days")) return "number";
  if(lk.startsWith("is") || lk.endsWith("flag") || lk.includes("optin") || lk.includes("consent")) return "checkbox";
  if(lk.includes("remarks") || lk.includes("notes") || lk.includes("address") || lk.includes("reason")) return "textarea";
  return "text";
}
function isReadOnly(field){
  const lk = field.toLowerCase();
  return (lk==="createdat" || lk==="updatedat" || lk==="timestamp" || lk==="verifylogid");
}

function renderForm(headers, pk){
  const wrap = document.getElementById("formFields");
  wrap.innerHTML = "";

  if(!headers.length){
    wrap.innerHTML = `<div class="smallmuted">No headers found for <b>${escapeHtml(PAGES[currentPage].sheet||"sheet")}</b>. Ensure your sheet has header row (Row 1).</div>`;
    return;
  }

  headers.forEach(h=>{
    const type = guessType(h);
    const ro = isReadOnly(h) || (pk && h===pk && (currentRow[pk]||"").toString().trim()!=="");

    const val = (currentRow[h] ?? "");
    const id = "f_" + h.replace(/[^a-z0-9_]/gi,"_");

    let inputHtml = "";
    if(type==="textarea"){
      inputHtml = `<textarea class="form-control" id="${id}" rows="2" ${ro?"readonly":""}>${escapeHtml(val)}</textarea>`;
    } else if(type==="checkbox"){
      const checked = String(val).toLowerCase()==="true" || String(val)==="1" || String(val).toLowerCase()==="yes";
      inputHtml = `
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="${id}" ${checked?"checked":""} ${ro?"disabled":""}>
          <label class="form-check-label smallmuted" for="${id}">Yes / No</label>
        </div>`;
    } else {
      inputHtml = `<input class="form-control ${h.toLowerCase().endsWith("id")?"mono":""}" id="${id}" type="${type}" value="${escapeHtml(val)}" ${ro?"readonly":""}>`;
    }

    wrap.insertAdjacentHTML("beforeend", `
      <div>
        <label class="form-label smallmuted mb-1">${escapeHtml(h)} ${pk===h?'<span class="badge text-bg-primary ms-1">PK</span>':''}</label>
        ${inputHtml}
      </div>
    `);
  });
}

function readForm(headers, pk){
  const out = {};
  headers.forEach(h=>{
    const id = "f_" + h.replace(/[^a-z0-9_]/gi,"_");
    const type = guessType(h);
    const el = document.getElementById(id);
    if(!el) return;
    if(type==="checkbox"){
      out[h] = !!el.checked;
    } else {
      out[h] = el.value;
    }
  });
  return out;
}

/** =========================================================
 * List rendering
 * ========================================================= */
function renderTable(headers, rows, pk){
  const head = document.getElementById("tblHead");
  const body = document.getElementById("tblBody");
  head.innerHTML = "";
  body.innerHTML = "";

  const showCols = (headers || []).slice(0, 7); // keep table compact
  showCols.forEach(h=> head.insertAdjacentHTML("beforeend", `<th class="smallmuted">${escapeHtml(h)}</th>`));
  head.insertAdjacentHTML("beforeend", `<th class="smallmuted">Action</th>`);

  rows.forEach((r, idx)=>{
    const tr = document.createElement("tr");
    showCols.forEach(h=>{
      tr.insertAdjacentHTML("beforeend", `<td>${escapeHtml(r[h] ?? "")}</td>`);
    });

    tr.insertAdjacentHTML("beforeend", `<td><button class="btn btn-sm btn-outline-primary">Load</button></td>`);
    tr.querySelector("button").addEventListener("click", ()=>{
      currentRow = r;
      renderForm(currentHeaders, currentPk);
      toast("ok", "Loaded", "Row loaded into form");
    });

    body.appendChild(tr);
  });

  document.getElementById("resultMeta").textContent = rows.length ? (rows.length + " rows") : "No rows";
  document.getElementById("tblNote").textContent = rows.length ? "Tip: Click Load to edit / print PDF" : "";
}

/** =========================================================
 * Page logic
 * ========================================================= */
async function openPage(pageKey){
  currentPage = pageKey;
  currentRow = {};
  lastList = [];
  const cfg = PAGES[pageKey];

  // menu active
  document.querySelectorAll(".menu-btn").forEach(b=>b.classList.toggle("active", b.dataset.page===pageKey));

  document.getElementById("pageTitle").textContent = cfg.title;
  document.getElementById("pageSub").textContent = "Create • Update • Search • PDF";
  document.getElementById("formTitle").textContent = cfg.title;
  document.getElementById("formHint").textContent = "Loading schema & data…";
  document.getElementById("pkInfo").textContent = cfg.pk || "—";
  document.getElementById("apiBadge").textContent = "API: JSONP";
  document.getElementById("schemaBadge").textContent = "Schema: …";
  document.getElementById("feeBox").style.display = "none";
  document.getElementById("extraArea").innerHTML = "";

  scrim(true, "Loading schema & list…");
  try{
    if(pageKey==="dashboard"){
      currentHeaders = [];
      currentPk = null;
      renderForm([], null);
      await loadDashboard();
      renderTable([], [], null);
      document.getElementById("formTitle").textContent = "Dashboard";
      document.getElementById("formHint").textContent = "Stats loaded";
      return;
    }

    if(pageKey==="verify"){
      renderVerifyForm();
      renderTable([], [], null);
      return;
    }

    currentHeaders = await loadSchema(cfg.sheet);
    currentPk = cfg.pk || null;

    renderForm(currentHeaders, currentPk);

    // list
    await refreshList();

    document.getElementById("formHint").textContent = "Ready";
  } catch(err){
    toast("err", "API Error", err.message || String(err));
    document.getElementById("formHint").textContent = "Error: " + (err.message || err);
  } finally {
    scrim(false);
  }
}

async function refreshList(){
  const cfg = PAGES[currentPage];
  if(!cfg || !cfg.module) return;

  // Special: batch allocations uses module=batch&action=allocations
  let action = "list";
  if(currentPage==="batchalloc") action = "allocations";

  // Attendance list needs filter, so default show last 0
  if(currentPage==="attendance"){
    lastList = [];
    renderTable(currentHeaders, [], currentPk);
    document.getElementById("formHint").textContent = "Attendance list requires studentId or batchId filter (use Global Search / Load record)";
    return;
  }

  const res = await apiGet({ module: cfg.module, action, limit: 80 });
  if(!res || res.ok===false) throw new Error(res?.error || "List failed");

  const data = Array.isArray(res.data) ? res.data : (Array.isArray(res?.data?.applications)? [] : []);
  lastList = data;
  renderTable(currentHeaders, lastList, currentPk);
}

async function saveCurrent(){
  const cfg = PAGES[currentPage];
  if(!cfg || !cfg.module) return;

  if(currentPage==="verify"){
    return runVerify();
  }

  const payload = readForm(currentHeaders, currentPk);

  // decide create/update
  const pk = cfg.pk;
  const hasPk = pk && String(payload[pk]||"").trim() !== "";

  let action = hasPk ? "update" : "create";
  // Some modules need POST in your backend; but JSONP requires GET.
  // Your backend already allows GET for create/update on enquiry/student/batch/attendance mark.
  // If any module is POST-only, host UI with ?ui=1 instead.
  const res = await apiGet(Object.assign({ module: cfg.module, action }, payload));

  if(!res || res.ok===false) throw new Error(res?.message || res?.error || "Save failed");

  // if backend returns pk, set it
  if(pk && res[pk]) payload[pk] = res[pk];

  currentRow = Object.assign({}, payload);
  renderForm(currentHeaders, currentPk);
  toast("ok", "Saved", (pk ? (pk + ": " + (res[pk] || payload[pk] || "")) : "Saved"));

  // refresh list
  await refreshList();
}

async function printPdf(){
  const cfg = PAGES[currentPage];
  if(!cfg) return;

  if(currentPage==="verify"){
    toast("warn","PDF","Verification has no PDF. Use Certificate module PDF.");
    return;
  }

  const pk = cfg.pk;
  if(!pk){
    toast("warn","PDF","This page has no single PK PDF endpoint.");
    return;
  }
  const payload = readForm(currentHeaders, currentPk);
  const id = String(payload[pk]||"").trim();
  if(!id){
    toast("warn","PDF","Save/load a record first (PK missing).");
    return;
  }

  // action names vary: many use pdf or printpdf
  const res = await apiGet({ module: cfg.module, action:"pdf", id });

  if(!res || res.ok===false) throw new Error(res?.error || "PDF failed");
  const url = res?.pdf?.pdfUrl || res?.pdfUrl || res?.pdf?.url;
  if(!url){
    toast("warn","PDF","PDF generated but URL not returned. Check createPdfFile_ response.");
    return;
  }
  window.open(url, "_blank");
}

async function loadDashboard(){
  const res = await apiGet({ module:"dashboard", action:"stats" });
  if(!res || res.ok===false) throw new Error(res?.error || "Dashboard failed");
  const d = res.data || {};
  const cards = [
    ["Total Enquiries", d.totalEnquiries ?? "-", "bi-chat-dots"],
    ["Total Students", d.totalStudents ?? "-", "bi-person-badge"],
    ["Total Admissions", d.totalAdmissions ?? "-", "bi-journal-check"],
    ["Today Collection", d.todayCollection ?? "-", "bi-cash-coin"]
  ];
  document.getElementById("extraArea").innerHTML = `
    <div class="row g-3">
      ${cards.map(c=>`
        <div class="col-md-3">
          <div class="panel p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="smallmuted">${escapeHtml(c[0])}</div>
                <div class="fw-bold fs-4">${escapeHtml(c[1])}</div>
              </div>
              <i class="bi ${c[2]} fs-3"></i>
            </div>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}

async function runGlobalSearch(){
  const q = document.getElementById("globalQ").value.trim();
  if(!q){ toast("warn","Search","Type something to search"); return; }

  scrim(true, "Searching…");
  try{
    const res = await apiGet({ module:"search", action:"global", q, limit: 80 });
    if(!res || res.ok===false) throw new Error(res?.error || "Search failed");

    const results = res.data?.results || [];
    document.getElementById("extraArea").innerHTML = `
      <div class="panel p-3 mt-3">
        <div class="fw-bold">Global Search Results</div>
        <div class="smallmuted">Query: <span class="mono">${escapeHtml(q)}</span> • ${results.length} hits</div>
        <div class="table-wrap mt-3">
          <table class="table table-sm table-hover mb-0">
            <thead class="sticky-top-2">
              <tr>
                <th>Sheet</th>
                <th>Preview</th>
              </tr>
            </thead>
            <tbody>
              ${results.map(r=>{
                const sheet = r.sheet;
                const data = r.data || {};
                const preview = Object.keys(data).slice(0,6).map(k=>`${k}: ${data[k]}`).join(" • ");
                return `<tr>
                  <td class="mono">${escapeHtml(sheet)}</td>
                  <td>${escapeHtml(preview)}</td>
                </tr>`;
              }).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;
    toast("ok","Search","Found " + results.length + " results");
  } catch(err){
    toast("err","Search error", err.message || String(err));
  } finally {
    scrim(false);
  }
}

/** Verify page UI */
function renderVerifyForm(){
  currentHeaders = [];
  currentPk = null;
  document.getElementById("pkInfo").textContent = "—";
  document.getElementById("formFields").innerHTML = `
    <div>
      <label class="form-label smallmuted mb-1">Certificate ID</label>
      <input id="v_certId" class="form-control mono" placeholder="CERT00001">
    </div>
    <div>
      <label class="form-label smallmuted mb-1">Verify Token</label>
      <input id="v_token" class="form-control mono" placeholder="12CHAR_TOKEN">
    </div>
    <div style="grid-column:1/-1">
      <label class="form-label smallmuted mb-1">Certificate Serial</label>
      <input id="v_serial" class="form-control mono" placeholder="SGM-CERT00001">
    </div>
    <div style="grid-column:1/-1" class="smallmuted">
      Fill any ONE field and click <b>Save</b> (Verify) or press Enter.
    </div>
  `;
  document.getElementById("formTitle").textContent = "Verify Certificate";
  document.getElementById("formHint").textContent = "Public verification (module=verify)";
}
async function runVerify(){
  const certificateId = document.getElementById("v_certId").value.trim();
  const verifyToken = document.getElementById("v_token").value.trim();
  const certificateSerial = document.getElementById("v_serial").value.trim();
  if(!certificateId && !verifyToken && !certificateSerial){
    toast("warn","Verify","Enter certificateId or verifyToken or certificateSerial");
    return;
  }
  scrim(true, "Verifying…");
  try{
    const res = await apiGet({ module:"verify", action:"certificate", certificateId, verifyToken, certificateSerial, source:"ERP_UI" });
    if(!res) throw new Error("No response");
    const st = res.resultStatus || "UNKNOWN";
    const d = res.data || null;

    const box = document.getElementById("extraArea");
    box.innerHTML = `
      <div class="panel p-3 mt-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <div class="fw-bold">Verification Result: <span class="mono">${escapeHtml(st)}</span></div>
            <div class="smallmuted">Verify Log ID: <span class="mono">${escapeHtml(res.verifyLogId || "-")}</span></div>
          </div>
        </div>
        <hr>
        ${d ? `
          <table class="table table-sm kv-table">
            <tbody>
              ${Object.keys(d).map(k=>`<tr><th class="smallmuted">${escapeHtml(k)}</th><td class="mono">${escapeHtml(d[k])}</td></tr>`).join("")}
            </tbody>
          </table>
        ` : `<div class="smallmuted">No certificate found.</div>`}
      </div>
    `;
    toast(st==="VALID" ? "ok" : (st==="REVOKED" ? "warn" : "err"), "Verify", st);
  } catch(err){
    toast("err","Verify error", err.message || String(err));
  } finally {
    scrim(false);
  }
}

/** =========================================================
 * Wire UI
 * ========================================================= */
document.querySelectorAll(".menu-btn").forEach(btn=>{
  btn.addEventListener("click", ()=> openPage(btn.dataset.page));
});

document.getElementById("btnRefresh").addEventListener("click", ()=> openPage(currentPage));
document.getElementById("btnNew").addEventListener("click", ()=>{
  currentRow = {};
  if(currentPage==="verify"){ renderVerifyForm(); return; }
  renderForm(currentHeaders, currentPk);
  toast("ok","New","Blank form ready");
});
document.getElementById("btnSave").addEventListener("click", ()=> saveCurrent().catch(e=>toast("err","Save error", e.message||String(e))));
document.getElementById("btnPdf").addEventListener("click", ()=> printPdf().catch(e=>toast("err","PDF error", e.message||String(e))));

document.getElementById("btnGlobalSearch").addEventListener("click", runGlobalSearch);
document.getElementById("globalQ").addEventListener("keydown", (e)=>{ if(e.key==="Enter") runGlobalSearch(); });

document.getElementById("btnTheme").addEventListener("click", ()=>{
  const dark = document.body.dataset.theme === "dark";
  document.body.dataset.theme = dark ? "light" : "dark";
  if(!dark){
    document.documentElement.style.setProperty("--bg", "#0b1220");
    document.documentElement.style.setProperty("--card", "#0f172a");
    document.documentElement.style.setProperty("--ink", "#e5e7eb");
    document.documentElement.style.setProperty("--muted", "#94a3b8");
    document.documentElement.style.setProperty("--line", "rgba(148,163,184,.25)");
  } else {
    document.documentElement.style.setProperty("--bg", "#f3f6fb");
    document.documentElement.style.setProperty("--card", "#ffffff");
    document.documentElement.style.setProperty("--ink", "#0f172a");
    document.documentElement.style.setProperty("--muted", "#64748b");
    document.documentElement.style.setProperty("--line", "#e5e7eb");
  }
});

document.getElementById("btnLogout").addEventListener("click", ()=>{
  toast("ok","Logout","Demo UI: add RBAC session later if you want");
});

/** =========================================================
 * Boot
 * ========================================================= */
(async function boot(){
  // quick health ping
  scrim(true, "Connecting to backend…");
  try{
    const h = await apiGet({ module:"health" });
    document.getElementById("apiBadge").textContent = "API: JSONP";
    toast("ok","Backend","Connected: " + (h.status || "UP"));
  } catch(err){
    document.getElementById("apiBadge").textContent = "API: ERROR";
    toast("err","API Error", (err && err.message) ? err.message : String(err));
  } finally {
    scrim(false);
  }

  openPage("dashboard");
})();
</script>
</body>
</html>
