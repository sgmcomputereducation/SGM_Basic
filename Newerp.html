<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SGM ERP • Corporate</title>
  <meta name="description" content="SGM Computer Education ERP"/>
  <link rel="icon" href="https://www.sgmcomputereducation.com/favicon.ico">
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b33; --muted:#94a3b8; --text:#e5e7eb;
      --line:rgba(148,163,184,.18); --brand:#60a5fa; --ok:#22c55e; --bad:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:16px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    body{margin:0;background:linear-gradient(120deg,#050914,#0b1220);color:var(--text);}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.82);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);}
    .topinner{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:14px 18px;max-width:1200px;margin:0 auto;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#60a5fa,#a78bfa);box-shadow:var(--shadow);}
    .brand h1{font-size:14px;margin:0;letter-spacing:.8px;}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .right{display:flex;gap:10px;align-items:center;}
    .pill{border:1px solid var(--line);background:rgba(255,255,255,.04);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);}
    .wrap{max-width:1200px;margin:18px auto;padding:0 18px;display:grid;grid-template-columns:260px 1fr;gap:16px;}
    .sidebar,.main{border:1px solid var(--line);border-radius:var(--radius);background:rgba(255,255,255,.03);box-shadow:var(--shadow);}
    .sidebar{padding:12px;}
    .navbtn{width:100%;text-align:left;border:1px solid transparent;background:transparent;color:var(--text);
      padding:10px 10px;border-radius:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
    .navbtn:hover{background:rgba(255,255,255,.05);border-color:var(--line);}
    .navbtn.active{background:rgba(96,165,250,.12);border-color:rgba(96,165,250,.35);}
    .main{padding:14px;}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    .card{border:1px solid var(--line);border-radius:var(--radius);background:rgba(255,255,255,.03);padding:12px;}
    .card .k{font-size:12px;color:var(--muted)}
    .card .v{font-size:24px;margin-top:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0;}
    input,select,textarea{
      background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--text);
      padding:10px 10px;border-radius:12px;outline:none;min-width:220px;
    }
    textarea{min-height:90px;min-width:min(720px,100%);}
    .btn{
      border:1px solid rgba(96,165,250,.45);background:rgba(96,165,250,.18);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;
    }
    .btn:hover{background:rgba(96,165,250,.25);}
    .btn.danger{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.16);}
    .muted{color:var(--muted);font-size:12px;}
    .hr{height:1px;background:var(--line);margin:12px 0;}
    .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;overflow:hidden;border-radius:14px;border:1px solid var(--line);}
    .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--line);font-size:13px;}
    .tbl th{background:rgba(255,255,255,.04);text-align:left;color:var(--muted);font-weight:600;}
    .tbl tr:last-child td{border-bottom:none;}
    .status{padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;}
    .ok{color:var(--ok);}
    .bad{color:var(--bad);}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}.grid{grid-template-columns:1fr}.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topinner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>SGM COMPUTER EDUCATION</h1>
          <div class="sub">Registered Under MSME | ISO 9001-2015 Certified Center • 9742266359 • info@sgmcomputereducation.com • sgmcomputereducation.com</div>
        </div>
      </div>
      <div class="right">
        <span class="pill" id="apiStatus">API: checking…</span>
        <span class="pill" id="roleBadge">Role: Admin</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="sidebar" id="sidebar"></div>

    <div class="main">
      <div id="pageTitle" style="font-size:18px;font-weight:700;">Dashboard</div>
      <div class="muted" id="pageHint">Corporate ERP • Schema-driven modules • Auto PDF</div>

      <div class="hr"></div>

      <div id="page"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG (EDIT THIS)
 * ========================= */
// Your Apps Script Web App EXEC URL:
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxy8Hsg63xBnyd1l43YPfRHaUiS-KwoMvocD3v33ALZh6un8im797QOqxh5CMvwNs4f/exec";

// If hosting on GitHub: set "jsonp" AND add the json_() backend change shown above.
const API_MODE = "same-origin"; // "same-origin" | "jsonp"

/** =========================
 * API CLIENT
 * ========================= */
function qs(params){ return Object.keys(params).map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k]??"")).join("&"); }

function apiGet(params){
  if(API_MODE === "jsonp") return apiJsonp(params);
  // same-origin / normal JSON
  const url = WEB_APP_URL + "?" + qs(params);
  return fetch(url, { method:"GET", redirect:"follow" }).then(r => r.json());
}

function apiPost(params, bodyObj){
  // Apps Script accepts POST; if you only implemented GET, keep using GET.
  const url = WEB_APP_URL + "?" + qs(params);
  return fetch(url, {
    method:"POST",
    headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body: qs(bodyObj || {})
  }).then(r => r.json());
}

function apiJsonp(params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const timeout = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 15000);
    function cleanup(){
      clearTimeout(timeout);
      delete window[cb];
      script.remove();
    }
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    const script = document.createElement("script");
    script.src = WEB_APP_URL + "?" + qs({...params, callback: cb});
    script.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };
    document.head.appendChild(script);
  });
}

/** =========================
 * UI (MODULES)
 * ========================= */
const state = {
  schema: null,
  active: "dashboard",
  moduleList: [
    {id:"dashboard", label:"Dashboard"},
    {id:"enquiry", label:"Enquiry Form"},
    {id:"admission", label:"Admission Form"},
    {id:"receipt", label:"Receipt Form"},
    {id:"batch", label:"Batch"},
    {id:"attendance", label:"Attendance"},
    {id:"exam", label:"Exam"},
    {id:"certificate", label:"Certificate"},
    {id:"verify", label:"Verify Certificate"}
  ]
};

function el(html){ const d=document.createElement("div"); d.innerHTML=html.trim(); return d.firstChild; }
function setActive(id){
  state.active = id;
  renderSidebar();
  renderPage();
}

function renderSidebar(){
  const sb = document.getElementById("sidebar");
  sb.innerHTML = "";
  state.moduleList.forEach(m=>{
    const b = el(`<button class="navbtn ${m.id===state.active?"active":""}">
      <span>${m.label}</span><span style="color:var(--muted)">›</span>
    </button>`);
    b.onclick=()=>setActive(m.id);
    sb.appendChild(b);
  });
}

function card(k,v){
  return `<div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>`;
}

async function renderPage(){
  const page = document.getElementById("page");
  const title = document.getElementById("pageTitle");
  const hint = document.getElementById("pageHint");

  if(state.active==="dashboard"){
    title.textContent="Dashboard";
    hint.textContent="Quick overview (live from backend)";
    page.innerHTML = `<div class="grid" id="dashCards">${card("Total Enquiries","—")}${card("Admissions","—")}${card("Today Collection","—")}</div>
      <div class="hr"></div>
      <div class="muted">Tip: If this stays blank, your API is not reachable or CORS is blocking GitHub calls.</div>`;
    try{
      const r = await apiGet({module:"dashboard", action:"summary"});
      // If you don’t have dashboard module, it’s OK — shows error
      if(r && r.ok && r.data){
        const c = document.getElementById("dashCards");
        c.innerHTML =
          card("Total Enquiries", r.data.totalEnquiries ?? 0) +
          card("Admissions", r.data.totalAdmissions ?? 0) +
          card("Today Collection", r.data.todayCollection ?? 0);
      }
    }catch(e){}
    return;
  }

  if(state.active==="verify"){
    title.textContent="Verify Certificate";
    hint.textContent="Public verification by Certificate ID / Serial / Token";
    page.innerHTML = `
      <div class="row">
        <input id="vInput" placeholder="CERT00001 or SGM-CERT-... or token">
        <button class="btn" id="vBtn">Verify</button>
      </div>
      <div id="vOut" class="card muted">Enter a certificate value and click Verify.</div>`;
    document.getElementById("vBtn").onclick = async ()=>{
      const val = document.getElementById("vInput").value.trim();
      if(!val) return;
      const out = document.getElementById("vOut");
      out.textContent="Checking…";
      try{
        const r = await apiGet({module:"verify", action:"certificate", certificateId: val});
        out.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${r.ok?"✅ Verified":"❌ Not Found"}</div>
          <pre style="white-space:pre-wrap;margin:0;color:var(--muted)">${JSON.stringify(r,null,2)}</pre>`;
      }catch(e){
        out.innerHTML = `<div class="bad" style="font-weight:700">Error</div><div class="muted">${e.message}</div>`;
      }
    };
    return;
  }

  // Generic module form (basic template)
  title.textContent = state.moduleList.find(x=>x.id===state.active)?.label || "Module";
  hint.textContent = "Schema-driven save + auto-PDF (requires backend support)";
  page.innerHTML = `
    <div class="two">
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Create / Update</div>
        <div class="muted">This template sends fields as key=value pairs. Your backend must map & save.</div>
        <div class="hr"></div>
        <div class="row">
          <input id="f1" placeholder="Student / Enquiry Name">
          <input id="f2" placeholder="Phone">
        </div>
        <div class="row">
          <textarea id="f3" placeholder="Notes"></textarea>
        </div>
        <div class="row">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn danger" id="resetBtn">Reset</button>
          <span class="muted" id="saveMsg"></span>
        </div>
        <div class="hr"></div>
        <div class="muted">After save, if backend returns <b>pdfUrl</b>, it will open automatically.</div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Recent Records</div>
        <div class="muted">Loads list view if your backend supports action=list</div>
        <table class="tbl">
          <thead><tr><th>ID</th><th>Name</th><th>Status</th></tr></thead>
          <tbody id="listBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>`;

  document.getElementById("resetBtn").onclick=()=>{
    ["f1","f2","f3"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("saveMsg").textContent="";
  };

  document.getElementById("saveBtn").onclick = async ()=>{
    const saveMsg = document.getElementById("saveMsg");
    saveMsg.textContent="Saving…";
    const payload = {
      name: document.getElementById("f1").value.trim(),
      phone: document.getElementById("f2").value.trim(),
      notes: document.getElementById("f3").value.trim()
    };
    try{
      // Adjust these params to match your backend router
      const r = await apiPost({module: state.active, action:"save"}, payload);
      if(!r || !r.ok) throw new Error(r?.error || "Save failed");

      saveMsg.textContent = "Saved ✅";

      const pdfUrl = r.pdfUrl || r.data?.pdfUrl;
      if(pdfUrl) window.open(pdfUrl, "_blank");

      await loadListForActive();
    }catch(e){
      saveMsg.textContent = "Error: " + e.message;
    }
  };

  await loadListForActive();
}

async function loadListForActive(){
  const body = document.getElementById("listBody");
  if(!body) return;
  try{
    const r = await apiGet({module: state.active, action:"list", limit: 10});
    if(!r || !r.ok) { body.innerHTML = `<tr><td colspan="3" class="muted">${r?.error || "List not available"}</td></tr>`; return; }
    const rows = r.data || r.rows || [];
    if(!rows.length){ body.innerHTML = `<tr><td colspan="3" class="muted">No records</td></tr>`; return; }
    body.innerHTML = rows.slice(0,10).map(x=>`
      <tr>
        <td>${escapeHtml(x.id || x.enquiryId || x.admissionId || x.receiptId || x.certificateId || "—")}</td>
        <td>${escapeHtml(x.name || x.studentName || x.enquiryName || "—")}</td>
        <td><span class="status ${String(x.status||"").toLowerCase().includes("paid")?"ok":"muted"}">${escapeHtml(x.status||"—")}</span></td>
      </tr>`).join("");
  }catch(e){
    body.innerHTML = `<tr><td colspan="3" class="muted">List error: ${escapeHtml(e.message)}</td></tr>`;
  }
}

function escapeHtml(s){
  return String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** =========================
 * BOOT
 * ========================= */
(async function boot(){
  renderSidebar();

  // Health check
  try{
    const r = await apiGet({module:"health", action:"ping"});
    document.getElementById("apiStatus").textContent = "API: online";
  }catch(e){
    document.getElementById("apiStatus").textContent = "API: error";
    document.getElementById("apiStatus").style.borderColor = "rgba(239,68,68,.4)";
  }

  renderPage();
})();
</script>
</body>
</html>
