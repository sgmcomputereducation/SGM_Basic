<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGM Computer Education ‚Ä¢ ERP</title>
  <link rel="icon" href="https://sgmcomputereducation.com/favicon.ico">

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --card:#0c1730;
      --muted:#94a3b8; --text:#e5e7eb; --brand:#2563eb; --brand2:#22c55e;
      --border:rgba(148,163,184,.18); --shadow:0 12px 35px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(120deg,#0b1220,#0b1d3b 45%,#08101f);color:var(--text)}
    a{color:inherit}
    .topbar{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 18px;background:linear-gradient(90deg,#0b2a5f,#1d4ed8);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:12px;
      background:rgba(255,255,255,.12);display:grid;place-items:center;font-weight:800
    }
    .brand h1{margin:0;font-size:16px;line-height:1.2}
    .brand small{display:block;color:rgba(255,255,255,.85);font-weight:600}
    .chips{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.12);font-weight:700;font-size:12px}

    .wrap{display:grid;grid-template-columns:290px 1fr;gap:14px;padding:14px}
    .side{
      background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:var(--radius);
      padding:12px;box-shadow:var(--shadow);min-height:calc(100vh - 92px);
      position:sticky;top:78px;height:calc(100vh - 92px);overflow:auto;
    }
    .role{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 10px}
    .role b{font-size:12px;color:var(--muted)}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(34,197,94,.16);border:1px solid rgba(34,197,94,.35);color:#bbf7d0;font-weight:900;font-size:12px}
    .group{margin-top:12px}
    .group h3{margin:10px 0 8px;font-size:11px;letter-spacing:.18em;color:var(--muted)}
    .navbtn{
      width:100%;text-align:left;padding:10px 10px;border-radius:12px;border:1px solid transparent;
      background:transparent;color:var(--text);font-weight:800;cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .navbtn:hover{background:rgba(255,255,255,.06)}
    .navbtn.active{background:rgba(37,99,235,.18);border-color:rgba(37,99,235,.25)}
    .navbtn small{color:var(--muted);font-weight:800}

    .main{
      background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px;min-height:calc(100vh - 92px);
    }

    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title h2{margin:0;font-size:18px}
    .title p{margin:4px 0 0;color:var(--muted);font-weight:700;font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:900;cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{background:rgba(37,99,235,.20);border-color:rgba(37,99,235,.30)}
    .btn.good{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.28)}
    .btn.danger{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.25)}

    .search{
      display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.06);border:1px solid var(--border);
      border-radius:999px;padding:10px 14px;min-width:320px;flex:1
    }
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--text);font-weight:800}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin-top:14px}
    .card{
      background:rgba(7,14,28,.60);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:12px;
    }
    .card h3{margin:0 0 8px;font-size:14px}
    .muted{color:var(--muted);font-weight:700;font-size:12px}

    .formgrid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);outline:none;font-weight:800;
    }
    .field textarea{min-height:92px;resize:vertical}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .span2{grid-column:span 2}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.16);text-align:left;font-size:12px}
    th{color:var(--muted);font-weight:900}
    tr:hover td{background:rgba(255,255,255,.04);cursor:pointer}

    .toast{
      position:fixed;right:16px;bottom:16px;z-index:999;
      width:min(430px, calc(100vw - 32px));
      border-radius:16px;padding:12px 12px;border:1px solid rgba(239,68,68,.35);
      background:rgba(30,8,8,.92);box-shadow:var(--shadow);display:none;
    }
    .toast.ok{border-color:rgba(34,197,94,.35);background:rgba(6,18,10,.92)}
    .toast .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .toast b{font-size:13px}
    .toast p{margin:6px 0 0;color:rgba(255,255,255,.85);font-weight:700;font-size:12px}
    .x{background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:10px;width:34px;height:34px;cursor:pointer}

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr}
      .side{position:relative;top:0;height:auto}
      .grid{grid-template-columns:1fr}
      .formgrid{grid-template-columns:1fr}
      .span2{grid-column:auto}
      .search{min-width:220px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">üéì</div>
      <div>
        <h1>SGM COMPUTER EDUCATION</h1>
        <small>Registered Under MSME | ISO 9001-2015 Certified Center</small>
      </div>
    </div>
    <div class="chips">
      <div class="chip">üìû 9742266359</div>
      <div class="chip">üí¨ WhatsApp 9742266359</div>
      <div class="chip">‚úâÔ∏è info@sgmcomputereducation.com</div>
      <div class="chip">üåê sgmcomputereducation.com</div>
    </div>
  </div>

  <div class="wrap">
    <aside class="side">
      <div class="role">
        <b>ERP Menu</b>
        <span class="badge" id="roleBadge">ROLE: ADMIN</span>
      </div>
      <div class="muted">Single-file UI ‚Ä¢ Auto-forms from Schema ‚Ä¢ JSONP/JSON compatible</div>

      <div class="group">
        <h3>DASHBOARD</h3>
        <button class="navbtn active" data-page="dashboard">Dashboard <small>stats</small></button>
        <button class="navbtn" data-page="search">Global Search <small>all</small></button>
      </div>

      <div class="group">
        <h3>LEADS & STUDENTS</h3>
        <button class="navbtn" data-page="enquiry">Enquiry <small>Enquiries</small></button>
        <button class="navbtn" data-page="student">Student <small>Students</small></button>
        <button class="navbtn" data-page="admission">Admission <small>Admissions</small></button>
      </div>

      <div class="group">
        <h3>FEES</h3>
        <button class="navbtn" data-page="receipt">Receipt <small>Receipts</small></button>
        <button class="navbtn" data-page="emi">EMI / Fee Balance <small>EMI_Plan</small></button>
      </div>

      <div class="group">
        <h3>BATCH & TRAINING</h3>
        <button class="navbtn" data-page="batch">Batch <small>Batches</small></button>
        <button class="navbtn" data-page="allocation">Batch Allocation <small>BatchAllocations</small></button>
        <button class="navbtn" data-page="completion">Course Completion <small>CourseCompletion</small></button>
        <button class="navbtn" data-page="exam">Exam / Result <small>Exams</small></button>
      </div>

      <div class="group">
        <h3>CERTIFICATE</h3>
        <button class="navbtn" data-page="cert_app">Certificate Application <small>Certificate_Applications</small></button>
        <button class="navbtn" data-page="cert_issued">Certificate Issued <small>Certificates_Issued</small></button>
        <button class="navbtn" data-page="verify">Verify Certificate <small>Public</small></button>
      </div>

      <div class="group">
        <h3>SETTINGS</h3>
        <button class="navbtn" id="btnReloadSchema">Reload Schema <small>schema/all</small></button>
        <button class="navbtn" id="btnOpenBackend">Open Backend <small>exec</small></button>
      </div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <div class="title">
          <h2 id="pageTitle">Dashboard</h2>
          <p id="pageHint">Connecting to backend & schema‚Ä¶</p>
        </div>

        <div class="actions">
          <div class="search" id="topSearchWrap">
            üîé <input id="topSearch" placeholder="Search in current module (or use Global Search tab)" />
          </div>
          <button class="btn" id="btnRefresh">‚ü≥ Refresh</button>
          <button class="btn primary" id="btnNew">Ôºã New</button>
          <button class="btn good" id="btnSave">üíæ Save</button>
          <button class="btn" id="btnPdf">üìÑ PDF</button>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <h3 id="formTitle">Form</h3>
          <div class="muted" id="formSub">Auto-generated from schema headers</div>
          <div style="height:10px"></div>
          <div id="formArea" class="muted">Loading schema‚Ä¶</div>
          <div style="height:10px"></div>
          <div class="muted" id="saveNote"></div>
        </section>

        <section class="card">
          <h3>Results</h3>
          <div class="muted" id="resultsSub">List view ‚Ä¢ click a row to load into form</div>
          <div style="height:10px"></div>
          <div id="resultsArea" class="muted">No data loaded.</div>
        </section>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">
    <div class="row">
      <div>
        <b id="toastTitle">API Error</b>
        <p id="toastMsg">‚Ä¶</p>
      </div>
      <button class="x" onclick="hideToast()">√ó</button>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG (PASTE YOUR WEBAPP URL)
 *  ========================= */
const BASE_URL = "https://script.google.com/macros/s/AKfycbxy8Hsg63xBnyd1l43YPfRHaUiS-KwoMvocD3v33ALZh6un8im797QOqxh5CMvwNs4f/exec";

/** =========================
 *  MODULE MAP (matches your .gs routes)
 *  ========================= */
const PAGES = {
  dashboard: { title:"Dashboard", hint:"Stats overview", module:"dashboard", sheet:null, pk:null,
    listAction:"stats", saveMode:null },

  search: { title:"Global Search", hint:"Search across all modules", module:"search", sheet:null, pk:null,
    listAction:"global", saveMode:null },

  enquiry: { title:"Enquiry", hint:"Create ‚Ä¢ Update ‚Ä¢ Search ‚Ä¢ PDF", module:"enquiry", sheet:"Enquiries", pk:"enquiryId",
    listAction:"list", getAction:"get", createAction:"create", updateAction:"update", pdfAction:"pdf",
    saveMode:"jsonp-get" },

  student: { title:"Student", hint:"Create ‚Ä¢ Update ‚Ä¢ Search ‚Ä¢ PDF", module:"student", sheet:"Students", pk:"studentId",
    listAction:"list", getAction:"get", createAction:"create", updateAction:"update", pdfAction:"pdf",
    saveMode:"jsonp-get" },

  admission: { title:"Admission", hint:"List/Search/PDF (requires your modules_admission.gs)", module:"admission", sheet:"Admissions", pk:"admissionId",
    listAction:"list", getAction:"get", createAction:"create", updateAction:"update", pdfAction:"pdf",
    saveMode:"auto" },

  receipt: { title:"Receipt", hint:"Create ‚Ä¢ Update ‚Ä¢ Search ‚Ä¢ PDF", module:"receipt", sheet:"Receipts", pk:"receiptId",
    listAction:"list", getAction:"get", createAction:"create", updateAction:"update", pdfAction:"pdf",
    saveMode:"post-only" },

  emi: { title:"EMI / Fee Balance", hint:"Create/Update/MarkPaid/List", module:"emi", sheet:"EMI_Plan", pk:null,
    listAction:"list", getAction:"get", createAction:"create", updateAction:"update", pdfAction:null,
    saveMode:"post-only" },

  batch: { title:"Batch", hint:"Create ‚Ä¢ Update ‚Ä¢ Search ‚Ä¢ PDF", module:"batch", sheet:"Batches", pk:"batchId",
    listAction:"list", getAction:"get", createAction:"create", updateAction:"update", pdfAction:"pdf",
    saveMode:"jsonp-get" },

  allocation: { title:"Batch Allocation", hint:"List ‚Ä¢ Allocate ‚Ä¢ Deallocate ‚Ä¢ PDF", module:"batch", sheet:"BatchAllocations", pk:"allocationId",
    listAction:"allocations", getAction:null, createAction:"allocate", updateAction:"deallocate", pdfAction:"allocationPdf",
    saveMode:"jsonp-get" },

  completion: { title:"Course Completion", hint:"Mark/Update/List/Search/PDF", module:"completion", sheet:"CourseCompletion", pk:"completionId",
    listAction:"list", getAction:"get", createAction:"mark", updateAction:"update", pdfAction:"pdf",
    saveMode:"post-only" },

  exam: { title:"Exam / Result", hint:"Create/Update/List/Search/PDF", module:"exam", sheet:"Exams", pk:"examId",
    listAction:"list", getAction:"get", createAction:"create", updateAction:"update", pdfAction:"pdf",
    saveMode:"post-only" },

  cert_app: { title:"Certificate Application", hint:"Apply/Update/List/Search", module:"certificate", sheet:"Certificate_Applications", pk:"applicationId",
    listAction:"list", getAction:"getApp", createAction:"apply", updateAction:"updateApp", pdfAction:null,
    saveMode:"post-only" },

  cert_issued: { title:"Certificate Issued", hint:"Issue/Update/List/Search/PDF", module:"certificate", sheet:"Certificates_Issued", pk:"certificateId",
    listAction:"list", getAction:"get", createAction:"issue", updateAction:"updateIssued", pdfAction:"pdf",
    saveMode:"post-only" },

  verify: { title:"Verify Certificate", hint:"Public verification by CertificateId / Token / Serial", module:"verify", sheet:null, pk:null,
    listAction:"certificate", saveMode:null }
};

let SCHEMA = null;
let currentPage = "dashboard";
let currentRecord = {};
let currentRows = [];
let currentHeaders = [];

const $ = (id)=>document.getElementById(id);

function showToast(title,msg,ok=false){
  const t=$("toast"); $("toastTitle").textContent=title; $("toastMsg").textContent=msg;
  t.classList.toggle("ok", !!ok);
  t.style.display="block";
}
function hideToast(){ $("toast").style.display="none"; }

/** =========================
 * JSONP helper (GitHub Pages safe)
 * ========================= */
function jsonp(url, params={}){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cb;

    const qs = new URLSearchParams(params);
    const full = url + (url.includes("?") ? "&" : "?") + qs.toString();

    const s = document.createElement("script");
    s.src = full;
    s.async = true;

    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };

    s.onerror = ()=>{
      cleanup();
      reject(new Error("JSONP network error"));
    };

    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    document.body.appendChild(s);
  });
}

/** =========================
 * Try POST fetch (works when hosted INSIDE Apps Script / same origin)
 * On GitHub Pages: this will usually fail due to CORS (we detect and message).
 * ========================= */
async function postJson(url, params={}, bodyObj={}){
  const u = url + (url.includes("?") ? "&" : "?") + new URLSearchParams(params).toString();
  const res = await fetch(u, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(bodyObj)
  });
  return await res.json();
}

/** =========================
 * Load schema
 * ========================= */
async function loadSchema(){
  $("pageHint").textContent = "Loading schema from backend‚Ä¶";
  try{
    const data = await jsonp(BASE_URL, { module:"schema", action:"all" });
    if(!data || !data.ok) throw new Error((data && (data.error||data.message)) || "Schema error");
    SCHEMA = data.sheets || {};
    $("pageHint").textContent = "Schema loaded ‚úì";
    renderPage(currentPage);
  }catch(err){
    showToast("API Error", "Could not load schema. Check: (1) DB_SPREADSHEET_ID in Script Properties, (2) json_() supports JSONP, (3) deploy access Anyone. Error: " + err.message);
    $("pageHint").textContent = "Schema load failed ‚úï";
    $("formArea").innerHTML = `<div class="muted">
      <b>Schema load failed.</b><br><br>
      Test this URL (must return cb(...)):<br>
      <span class="mono">${BASE_URL}?module=schema&action=listSheets&callback=cb</span>
    </div>`;
  }
}

/** =========================
 * Build form from schema headers
 * ========================= */
function guessType(h){
  const lk=(h||"").toLowerCase();
  if(lk.endsWith("id")||lk.includes("uuid")) return "text_mono";
  if(lk.includes("date") && !lk.includes("datetime")) return "date";
  if(lk.includes("datetime")||lk.includes("timestamp")) return "datetime";
  if(lk.includes("amount")||lk.includes("fee")||lk.includes("price")) return "number";
  if(lk.includes("status")) return "select";
  if(lk.includes("remarks")||lk.includes("notes")||lk.includes("address")||lk.includes("reason")) return "textarea";
  if(lk.startsWith("is")||lk.endsWith("flag")||lk.includes("optin")||lk.includes("consent")) return "checkbox";
  return "text";
}

function renderForm(headers, data){
  currentHeaders = headers || [];
  currentRecord = data || {};
  if(!headers || !headers.length){
    $("formArea").innerHTML = `<div class="muted">No headers found. Ensure your sheet has header row.</div>`;
    return;
  }

  const html = [];
  html.push(`<div class="formgrid">`);
  headers.forEach(h=>{
    const t = guessType(h);
    const v = (data && data[h] != null) ? String(data[h]) : "";
    const ro = ["createdAt","updatedAt","timestamp","verifyLogId"].includes(h);

    const cls = (t==="text_mono") ? "mono" : "";
    const span2 = (t==="textarea") ? "span2" : "";
    html.push(`<div class="field ${span2}">
      <label>${escapeHtml(h)}</label>
      ${renderInput(h,t,v,ro,cls)}
    </div>`);
  });
  html.push(`</div>`);
  $("formArea").innerHTML = html.join("");

  // PK readonly if present
  const page = PAGES[currentPage];
  if(page && page.pk){
    const el = document.querySelector(`[name="${cssEsc(page.pk)}"]`);
    if(el) el.readOnly = true;
  }
}

function renderInput(name,type,val,readOnly,cls){
  const ro = readOnly ? "readonly" : "";
  if(type==="textarea"){
    return `<textarea class="${cls}" ${ro} name="${escapeAttr(name)}">${escapeHtml(val)}</textarea>`;
  }
  if(type==="checkbox"){
    const checked = String(val).toLowerCase()==="true" || val==="1" || String(val).toLowerCase()==="yes";
    return `<input type="checkbox" name="${escapeAttr(name)}" ${checked?"checked":""} ${readOnly?"disabled":""}/>`;
  }
  if(type==="select"){
    // generic select; user can type values by switching to text if needed
    const opts = ["","Active","Inactive","Pending","Paid","Due","Deleted","Issued","Submitted","Completed"];
    return `<select name="${escapeAttr(name)}" ${readOnly?"disabled":""} class="${cls}">
      ${opts.map(o=>`<option value="${escapeAttr(o)}" ${o===val?"selected":""}>${escapeHtml(o||"-")}</option>`).join("")}
      ${(!opts.includes(val) && val) ? `<option value="${escapeAttr(val)}" selected>${escapeHtml(val)}</option>`:""}
    </select>`;
  }
  const itype = (type==="number") ? "number" : (type==="date" ? "date" : "text");
  return `<input class="${cls}" type="${itype}" name="${escapeAttr(name)}" value="${escapeAttr(val)}" ${ro} />`;
}

function readForm(){
  const out = {};
  currentHeaders.forEach(h=>{
    const el = document.querySelector(`[name="${cssEsc(h)}"]`);
    if(!el) return;
    if(el.type==="checkbox") out[h] = el.checked;
    else out[h] = el.value;
  });
  return out;
}

/** =========================
 * Results table
 * ========================= */
function renderResults(rows){
  currentRows = Array.isArray(rows) ? rows : [];
  if(!currentRows.length){
    $("resultsArea").innerHTML = `<div class="muted">No rows found.</div>`;
    return;
  }
  const page = PAGES[currentPage];
  const pk = page && page.pk;
  const cols = (pk ? [pk] : []).concat(currentHeaders.slice(0,4).filter(h=>h!==pk));

  const head = `<tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr>`;
  const body = currentRows.map((r,idx)=>{
    return `<tr data-i="${idx}">${cols.map(c=>`<td>${escapeHtml(r[c]==null?"":String(r[c]))}</td>`).join("")}</tr>`;
  }).join("");

  $("resultsArea").innerHTML = `<table><thead>${head}</thead><tbody>${body}</tbody></table>`;
  $("resultsArea").querySelectorAll("tbody tr").forEach(tr=>{
    tr.addEventListener("click", ()=>{
      const i = Number(tr.getAttribute("data-i"));
      const row = currentRows[i] || {};
      renderForm(currentHeaders, row);
      showToast("Loaded", "Row loaded into form", true);
    });
  });
}

/** =========================
 * API calls per page
 * ========================= */
async function refreshPage(){
  const page = PAGES[currentPage];
  if(!page){ return; }

  $("pageHint").textContent = page.hint || "";

  // Special pages
  if(currentPage==="dashboard"){
    $("topSearchWrap").style.display="none";
    $("btnNew").style.display="none";
    $("btnSave").style.display="none";
    $("btnPdf").style.display="none";
    $("formTitle").textContent="Dashboard";
    $("formSub").textContent="Live stats from backend";
    try{
      const d = await jsonp(BASE_URL, { module:"dashboard", action:"stats" });
      if(!d.ok) throw new Error(d.error||"stats error");
      const obj = d.data || {};
      $("formArea").innerHTML = `<div class="formgrid">
        ${Object.keys(obj).map(k=>`
          <div class="card" style="padding:12px">
            <div class="muted">${escapeHtml(k)}</div>
            <div style="font-size:22px;font-weight:950;margin-top:6px">${escapeHtml(String(obj[k]))}</div>
          </div>`).join("")}
      </div>`;
      $("resultsArea").innerHTML = `<div class="muted">Use the menu to manage modules.</div>`;
    }catch(err){
      showToast("API Error","Dashboard stats failed: "+err.message);
    }
    return;
  }

  if(currentPage==="search"){
    $("topSearchWrap").style.display="flex";
    $("btnNew").style.display="none";
    $("btnSave").style.display="none";
    $("btnPdf").style.display="none";
    $("formTitle").textContent="Global Search";
    $("formSub").textContent="Search across all sheets";
    $("formArea").innerHTML = `<div class="muted">Type in the top search box and press Enter.</div>`;
    $("resultsArea").innerHTML = `<div class="muted">No search yet.</div>`;
    return;
  }

  if(currentPage==="verify"){
    $("topSearchWrap").style.display="flex";
    $("btnNew").style.display="none";
    $("btnSave").style.display="none";
    $("btnPdf").style.display="none";
    $("formTitle").textContent="Verify Certificate";
    $("formSub").textContent="Enter CertificateId / Token / Serial in search box and press Enter";
    $("formArea").innerHTML = `<div class="muted">
      Example: CERT00001 or 12-CHAR TOKEN or SGM-CERT00001<br><br>
      The response shows VALID / REVOKED / NOT_FOUND.
    </div>`;
    $("resultsArea").innerHTML = `<div class="muted">No verification yet.</div>`;
    return;
  }

  // Regular module pages
  $("topSearchWrap").style.display="flex";
  $("btnNew").style.display="inline-block";
  $("btnSave").style.display="inline-block";
  $("btnPdf").style.display= page.pdfAction ? "inline-block" : "none";

  // schema headers for this sheet
  const sheetInfo = (SCHEMA && page.sheet) ? SCHEMA[page.sheet] : null;
  const headers = sheetInfo ? (sheetInfo.headers || []) : [];
  renderForm(headers, {});

  // Load list (best-effort)
  try{
    const params = { module: page.module, action: page.listAction || "list" };
    const list = await jsonp(BASE_URL, params);
    if(!list.ok) throw new Error(list.error||"list error");
    const rows = Array.isArray(list.data) ? list.data : (list.data && list.data.applications) ? [] : [];
    renderResults(rows);
  }catch(err){
    $("resultsArea").innerHTML = `<div class="muted">Could not load list. ${escapeHtml(err.message)}</div>`;
  }

  // Save note
  $("saveNote").textContent = getSaveNote(page);
}

function getSaveNote(page){
  if(page.saveMode==="post-only"){
    return "NOTE: This module currently uses POST-only backend. On GitHub Pages, POST is blocked by CORS. For full Save from GitHub, you must allow GET for create/update/mark actions (like you did for enquiry/student/batch), OR host UI via Apps Script (?ui=1).";
  }
  if(page.saveMode==="jsonp-get"){
    return "Save uses JSONP GET (GitHub Pages compatible).";
  }
  return "Save mode depends on your backend routes.";
}

async function saveCurrent(){
  const page = PAGES[currentPage];
  if(!page || !page.createAction) return;

  const data = readForm();
  const pk = page.pk;
  const hasPk = pk && data[pk] && String(data[pk]).trim();

  try{
    // Prefer JSONP GET if enabled
    if(page.saveMode==="jsonp-get"){
      const action = hasPk ? page.updateAction : page.createAction;
      const res = await jsonp(BASE_URL, Object.assign({ module:page.module, action }, data));
      if(!res.ok) throw new Error(res.error||res.message||"Save failed");
      showToast("Saved", (pk ? (pk + ": " + (res[pk] || data[pk] || res.id || "")) : "Saved") , true);
      await refreshPage();
      return;
    }

    // POST-only: try fetch (works only when NOT CORS blocked)
    if(page.saveMode==="post-only"){
      const action = hasPk ? page.updateAction : page.createAction;
      const res = await postJson(BASE_URL, { module:page.module, action }, data);
      if(!res.ok) throw new Error(res.error||res.message||"Save failed");
      showToast("Saved","Saved successfully", true);
      await refreshPage();
      return;
    }

    // fallback
    showToast("Save not configured", "This module needs save route configuration.");
  }catch(err){
    showToast("API Error", err.message);
  }
}

async function openPdf(){
  const page = PAGES[currentPage];
  if(!page || !page.pdfAction) return;

  const data = readForm();
  const pk = page.pk;
  const id = pk ? String(data[pk]||"").trim() : "";
  if(!id){
    showToast("PDF","Please load a record first (select from Results).");
    return;
  }

  // PDFs are GET ‚Üí safe to open in new tab
  const url = BASE_URL + "?" + new URLSearchParams({ module:page.module, action:page.pdfAction, id }).toString();
  window.open(url, "_blank");
}

/** =========================
 * Routing / UI
 * ========================= */
function setActiveNav(pageKey){
  document.querySelectorAll(".navbtn[data-page]").forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-page")===pageKey);
  });
}

function renderPage(pageKey){
  currentPage = pageKey;
  const page = PAGES[pageKey];
  if(!page) return;

  $("pageTitle").textContent = page.title;
  $("pageHint").textContent = page.hint || "";
  $("formTitle").textContent = page.title;
  $("formSub").textContent = "Auto-generated from schema headers";
  $("saveNote").textContent = "";

  setActiveNav(pageKey);
  refreshPage();
}

function wire(){
  document.querySelectorAll(".navbtn[data-page]").forEach(btn=>{
    btn.addEventListener("click", ()=> renderPage(btn.getAttribute("data-page")));
  });

  $("btnRefresh").addEventListener("click", refreshPage);
  $("btnNew").addEventListener("click", ()=>{
    renderForm(currentHeaders, {});
    showToast("New","Blank form ready", true);
  });
  $("btnSave").addEventListener("click", saveCurrent);
  $("btnPdf").addEventListener("click", openPdf);

  $("btnReloadSchema").addEventListener("click", loadSchema);
  $("btnOpenBackend").addEventListener("click", ()=> window.open(BASE_URL, "_blank"));

  $("topSearch").addEventListener("keydown", async (e)=>{
    if(e.key!=="Enter") return;
    const q = String(e.target.value||"").trim();
    if(!q) return;

    try{
      if(currentPage==="search"){
        const res = await jsonp(BASE_URL, { module:"search", action:"global", q, limit:100 });
        const arr = (res && res.data && res.data.results) ? res.data.results : [];
        $("resultsArea").innerHTML = `<div class="muted">Results: ${arr.length}</div><div style="height:10px"></div>` +
          `<table><thead><tr><th>Sheet</th><th>Data</th></tr></thead><tbody>` +
          arr.map(x=>`<tr><td><b>${escapeHtml(x.sheet)}</b></td><td class="mono">${escapeHtml(JSON.stringify(x.data))}</td></tr>`).join("") +
          `</tbody></table>`;
        return;
      }

      if(currentPage==="verify"){
        // try token/id/serial in one call
        const res = await jsonp(BASE_URL, { module:"verify", action:"certificate", certificateId:q, verifyToken:q, certificateSerial:q });
        if(!res.ok) throw new Error(res.error||"verify error");
        $("resultsArea").innerHTML = `<div class="muted">Status: <b>${escapeHtml(res.resultStatus||"")}</b></div><div style="height:10px"></div>
          <pre class="mono" style="white-space:pre-wrap;background:rgba(255,255,255,.06);padding:12px;border-radius:12px;border:1px solid var(--border)">${escapeHtml(JSON.stringify(res.data,null,2))}</pre>`;
        return;
      }

      // module local search if exists
      const page = PAGES[currentPage];
      if(page && page.module){
        const res = await jsonp(BASE_URL, { module:page.module, action:"search", q });
        if(res.ok && Array.isArray(res.data)){
          renderResults(res.data);
        }else{
          showToast("Search","Search not available for this module.");
        }
      }
    }catch(err){
      showToast("API Error", err.message);
    }
  });
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }
function cssEsc(s){ return CSS.escape(String(s||"")); }

wire();
loadSchema();
</script>

</body>
</html>
