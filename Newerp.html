<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGM Computer Education ERP</title>
  <meta name="description" content="SGM Computer Education ERP - Schema Driven" />
  <link rel="icon" href="https://sgmcomputereducation.com/favicon.ico">

  <!-- Corporate font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg:#f6f8fc; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#0b3d91; --primary2:#083274; --border:rgba(15,23,42,.10);
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:16px;
      --shadow-sm: 0 6px 16px rgba(2,8,23,.06);
      --shadow-md: 0 12px 26px rgba(2,8,23,.10);
      --shadow-lg: 0 22px 42px rgba(2,8,23,.14);
      --ring: 0 0 0 4px rgba(11,61,145,.14);
      --input-bg:#fff; --placeholder: rgba(100,116,139,.75);
      --sidebar:#0b1630; --sidebar2:#0a1e46; --sidebarText: rgba(255,255,255,.86); --sidebarMuted: rgba(255,255,255,.65);
      --glassBorder: rgba(15,23,42,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(11,61,145,.12), transparent 60%),
                  radial-gradient(900px 480px at 10% 10%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .app{display:grid;grid-template-columns: 270px 1fr;min-height:100vh;}
    @media(max-width:1024px){ .app{grid-template-columns: 1fr} }

    .sidebar{
      position:sticky; top:0; height:100vh;
      background: linear-gradient(180deg, var(--sidebar), var(--sidebar2));
      color: var(--sidebarText);
      padding: 16px 14px;
      overflow:auto;
      border-right: 1px solid rgba(255,255,255,.08);
    }
    @media(max-width:1024px){
      .sidebar{position:fixed; inset:0 auto 0 0; width: 280px; transform: translateX(-110%); transition: transform .18s ease; z-index: 50; box-shadow: 0 30px 70px rgba(2,8,23,.35);}
      body.nav-open .sidebar{ transform: translateX(0); }
      .backdrop{display:none;}
      body.nav-open .backdrop{display:block; position:fixed; inset:0; background: rgba(2,8,23,.45); backdrop-filter: blur(2px); z-index: 49;}
    }

    .sb-top{display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 4px 4px 12px;}
    .sb-brand{display:flex; align-items:center; gap:10px;}
    .sb-logo{
      width:44px;height:44px;border-radius:14px;
      background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center; font-weight: 900; letter-spacing:.5px;
      box-shadow: 0 8px 18px rgba(2,8,23,.20) inset; user-select:none;
    }
    .sb-title{display:flex; flex-direction:column; line-height:1.1;}
    .sb-title b{font-size:13px; letter-spacing:.2px}
    .sb-title span{font-size:12px; opacity:.8}

    .sb-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius:999px;
      background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.14);
      font-size:12px; font-weight:800; white-space:nowrap; margin: 8px 4px 12px;
    }
    .sb-chip:before{
      content:""; width:8px;height:8px;border-radius:50%;
      background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.18);
    }
    .sb-search{padding: 0 4px 10px;}
    .sb-search .inp{
      width:100%;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff; border-radius: 14px; padding: 11px 12px; outline:none;
    }
    .sb-search .inp::placeholder{color: rgba(255,255,255,.55)}
    .sb-search .inp:focus{ box-shadow: 0 0 0 4px rgba(255,255,255,.10) }

    .sb-nav{padding: 8px 4px; display:flex; flex-direction:column; gap:6px;}
    .nav-item{
      width:100%; display:flex; align-items:center; gap:10px;
      border:none; background: transparent; color: var(--sidebarText);
      padding: 10px 10px; border-radius: 14px; cursor:pointer; text-align:left;
      font-weight: 800; letter-spacing:.2px; transition: background .12s ease, transform .04s ease, color .12s ease;
    }
    .nav-item:hover{ background: rgba(255,255,255,.08); }
    .nav-item:active{ transform: translateY(1px); }
    .nav-item.active{
      background: linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.10));
      outline: 1px solid rgba(255,255,255,.16);
    }
    .nav-ico{
      width:32px;height:32px;border-radius:12px;
      background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.12);
      display:grid; place-items:center; flex: 0 0 32px;
    }
    .nav-ico svg{width:18px;height:18px}
    .nav-meta{display:flex; flex-direction:column; line-height:1.15; min-width:0;}
    .nav-meta small{
      color: var(--sidebarMuted);
      font-weight:700; font-size:11px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 180px;
    }

    .sb-footer{
      margin-top: 14px; padding: 12px 10px; border-radius: 16px;
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.78); font-size: 12px; line-height:1.45;
    }
    .sb-footer a{color:#fff; font-weight:900; text-decoration:none}
    .sb-footer a:hover{text-decoration:underline}

    .main{padding: 16px; min-width:0;}
    .wrap{max-width:1200px;margin:0 auto}

    .cmdbar{
      position: sticky; top: 0; z-index: 10; margin: 0 0 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.78), rgba(255,255,255,.60));
      border: 1px solid var(--glassBorder);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: var(--shadow-md);
      padding: 12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      overflow:hidden;
    }
    .cmd-left{display:flex; align-items:center; gap:10px; min-width:0}
    .hamb{
      display:none; border: 1px solid var(--border);
      background: #fff; border-radius: 14px; padding: 10px 12px;
      cursor:pointer; font-weight: 900; box-shadow: var(--shadow-sm);
    }
    @media(max-width:1024px){ .hamb{display:inline-flex; align-items:center; gap:8px} }
    .titleblock{display:flex; flex-direction:column; min-width:0}
    .titleblock b{font-size:14px; letter-spacing:.2px}
    .titleblock span{
      font-size:12px; color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 54vw;
    }

    .cmd-right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .mini{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 900; font-size: 12px; color: var(--text);
      box-shadow: var(--shadow-sm);
      white-space:nowrap;
    }
    .mini .dot{width:8px;height:8px;border-radius:50%; background:#ef4444; box-shadow: 0 0 0 4px rgba(239,68,68,.18);}
    .quick{display:flex; gap:8px; flex-wrap:wrap;}
    .qbtn{
      border:1px solid var(--border); background:#fff;
      border-radius: 14px; padding: 10px 12px; cursor:pointer;
      font-weight: 900; font-size: 13px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: var(--shadow-sm);
      transition: transform .04s ease, box-shadow .12s ease, border-color .12s ease;
      white-space:nowrap;
    }
    .qbtn:hover{border-color: rgba(11,61,145,.25); box-shadow: var(--shadow-md)}
    .qbtn:active{transform: translateY(1px)}
    .qbtn.primary{border-color: transparent; color: #fff; background: linear-gradient(135deg, var(--primary), var(--primary2));}
    .qbtn svg{width:18px;height:18px}

    .hero{
      border-radius: 22px; overflow:hidden;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      background:
        linear-gradient(135deg, rgba(11,61,145,.86), rgba(8,50,116,.78)),
        url("https://images.unsplash.com/photo-1556761175-b413da4baf72?auto=format&fit=crop&w=1800&q=70");
      background-size: cover; background-position: center;
      padding: 18px; color:#fff; position:relative; margin-bottom: 14px;
    }
    .hero:before{
      content:""; position:absolute; inset:0;
      background: radial-gradient(900px 380px at 10% 10%, rgba(255,255,255,.14), transparent 55%),
                  radial-gradient(900px 380px at 85% 0%, rgba(245,158,11,.14), transparent 55%);
      pointer-events:none;
    }
    .hero-inner{position:relative; display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap;}
    .hero h1{margin:0;font-size: 18px;letter-spacing:.2px;}
    .hero p{margin:6px 0 0;opacity:.95;font-size: 13px;line-height:1.5;max-width: 820px;}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow-sm);
    }
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media(max-width:960px){.grid{grid-template-columns:1fr}}

    h2{margin:0 0 6px;font-size:16px;letter-spacing:.2px}
    .sub{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.5}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;font-weight:600;letter-spacing:.15px;}
    input,select,textarea{
      width:100%; border:1px solid var(--border);
      border-radius:12px; padding:11px 12px;
      font-size:14px; outline:none; background:var(--input-bg);
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input::placeholder, textarea::placeholder{color:var(--placeholder)}
    input:hover, select:hover, textarea:hover{border-color:rgba(11,61,145,.18)}
    input:focus, select:focus, textarea:focus{border-color:rgba(11,61,145,.35); box-shadow: var(--ring);}
    textarea{min-height:86px;resize:vertical}
    input[readonly], textarea[readonly], select[disabled]{opacity:.75}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:none;border-radius:12px;padding:11px 14px;
      font-weight:900;cursor:pointer;font-size:14px;
      transition: transform .04s ease, box-shadow .12s ease, filter .12s ease, opacity .12s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{box-shadow:var(--shadow-sm)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn.danger{background:#fff;border:1px solid rgba(239,68,68,.35);color:var(--bad)}
    .btn svg{width:18px;height:18px}

    .status{
      margin-top:12px;padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);background:#fff;color:var(--muted);
      font-size:13px;line-height:1.45
    }
    .status.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.08);color:var(--ok)}
    .status.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08);color:var(--warn)}
    .status.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:var(--bad)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.5}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px;color:var(--muted)}
    .footer{
      margin:16px 0 0;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow: var(--shadow-sm);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
    }
    .footer a{color:var(--primary);text-decoration:none;font-weight:800}
    .footer a:hover{text-decoration:underline}

    .toast-wrap{position: fixed; right: 14px; bottom: 14px; display:flex; flex-direction:column; gap: 10px; z-index: 60; pointer-events:none;}
    .toast{
      pointer-events:auto; width: min(380px, calc(100vw - 28px));
      border-radius: 16px; padding: 12px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.86); backdrop-filter: blur(10px);
      box-shadow: var(--shadow-lg);
      display:flex; gap: 10px; align-items:flex-start; animation: pop .18s ease;
    }
    @keyframes pop{ from{transform: translateY(6px); opacity:0} to{transform:none; opacity:1} }
    .t-ico{width:34px;height:34px;border-radius: 14px; display:grid;place-items:center; background: rgba(11,61,145,.10); border:1px solid rgba(11,61,145,.14); flex: 0 0 34px;}
    .toast.ok .t-ico{background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.18)}
    .toast.warn .t-ico{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.20)}
    .toast.bad .t-ico{background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.18)}
    .toast b{display:block; font-size:13px}
    .toast p{margin:3px 0 0; font-size:12px; color: var(--muted); line-height:1.4}
    .toast .x{margin-left:auto; border:none; background: transparent; cursor:pointer; opacity:.7;}
    .toast .x:hover{opacity:1}

    .tbl{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--border); border-radius:14px;}
    .tbl th,.tbl td{padding:10px 12px; border-top:1px solid var(--border); font-size:13px; text-align:left; white-space:nowrap;}
    .tbl th{background:#fff; position:sticky; top:0;}
    .tbl tr:first-child th,.tbl tr:first-child td{border-top:none;}
    .tblwrap{overflow:auto; max-height:360px;}

    @media print{
      .sidebar, .cmdbar, .hero, .toast-wrap, .backdrop {display:none !important}
      .actions, .hint, .footer{display:none !important}
      body{background:#fff}
      .card{box-shadow:none}
      .main{padding:0}
    }
  </style>
</head>

<body>
  <div class="backdrop" onclick="toggleNav(false)"></div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Main navigation">
      <div class="sb-top">
        <div class="sb-brand">
          <div class="sb-logo">SGM</div>
          <div class="sb-title">
            <b>SGM ERP</b>
            <span>ISO 9001:2015 Certified</span>
          </div>
        </div>
        <button class="nav-item" type="button" style="width:auto;padding:10px 10px" onclick="toggleNav(false)" aria-label="Close menu">
          <span class="nav-ico"><i data-lucide="x"></i></span>
        </button>
      </div>

      <div class="sb-chip" id="sysChip">System: Connecting‚Ä¶</div>

      <div class="sb-search">
        <input id="menuSearch" class="inp" placeholder="Search menu‚Ä¶ (Enquiry, Receipt, Exam)" />
      </div>

      <nav class="sb-nav" id="sideNav"></nav>

      <div class="sb-footer">
        <div><b>Support</b></div>
        <div>üìû <a href="tel:+919742266359">+91 97422 66359</a></div>
        <div>‚úâÔ∏è <a href="mailto:info@sgmcomputereducation.com">info@sgmcomputereducation.com</a></div>
        <div style="margin-top:10px; opacity:.9">
          Version v2.0 ‚Ä¢ Updated: <span id="lastUpdated2"></span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="wrap">

        <!-- Command bar -->
        <div class="cmdbar">
          <div class="cmd-left">
            <button class="hamb" type="button" onclick="toggleNav(true)">
              <i data-lucide="menu"></i> Menu
            </button>

            <div class="titleblock">
              <b id="activeTitle">Loading‚Ä¶</b>
              <span>SGM COMPUTER EDUCATION ‚Ä¢ Registered Under MSME ‚Ä¢ ISO 9001-2015 ‚Ä¢ WhatsApp/Call: 9742266359</span>
            </div>
          </div>

          <div class="cmd-right">
            <span class="mini" title="Connection status">
              <span class="dot" id="liveDot"></span>
              <span id="liveText">Offline</span>
            </span>

            <div class="quick">
              <button class="qbtn" type="button" onclick="openGet({module:'health',action:'ping'})">
                <i data-lucide="activity"></i> Health
              </button>
              <button class="qbtn primary" type="button" onclick="window.print()">
                <i data-lucide="printer"></i> Print
              </button>
            </div>
          </div>
        </div>

        <!-- Hero -->
        <section class="hero" aria-label="ERP overview">
          <div class="hero-inner">
            <div>
              <h1>SGM Computer Education ‚Äî ERP Web App (Schema-Driven)</h1>
              <p>
                This UI auto-loads your Google Sheet columns from backend schema and creates correct forms for:
                Enquiry, Admission, Receipt, Batch, Batch Allocation, Attendance, Completion, Student Status, Exam, Exam Result,
                Course Completion Application, Certificate Application, Certificate, Verify Certificate.
              </p>
              <div class="hint" style="color:rgba(255,255,255,.85);margin-top:10px">
                ‚úÖ If you see ‚ÄúSchema loaded‚Äù, all forms will match sheet column headers exactly and save/PDF will work.
              </div>
            </div>
          </div>
        </section>

        <!-- Dynamic page -->
        <div id="page"></div>

        <footer class="footer">
          <div>
            <div style="font-weight:900;color:var(--text)">SGM ERP</div>
            <div class="footer-meta">Version v2.0 ‚Ä¢ Last Updated: <span id="lastUpdated"></span></div>
          </div>
          <div>
            Support:
            <a href="mailto:info@sgmcomputereducation.com">info@sgmcomputereducation.com</a>
            &nbsp;‚Ä¢&nbsp;
            <a href="tel:+919742266359">+91 97422 66359</a>
          </div>
        </footer>

      </div>
    </main>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

<script>
  /* ==========================================================
    CONFIG (EDIT ONLY THIS)
  ========================================================== */
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwAJJ8X8Wa3COmaPsZwLeUcL1Nwr0Mzv8SSKE4TXN2ssQztzh5KKIBLQzyNtyFrG4O_/exec";

  // Auto: GitHub pages => JSONP. Apps Script served UI => same-origin
  const API_MODE = /github\.io$/i.test(location.hostname) ? "jsonp" : "same-origin"; // "jsonp" | "same-origin"

  /* ==========================================================
    LABELS + ICONS (Your required menus)
  ========================================================== */
  const REQUIRED_ORDER = [
    "dashboard",
    "enquiry",
    "admission",
    "receipt",
    "batch",
    "batch_allocation",
    "attendance",
    "completion",
    "student_status",
    "exam",
    "exam_result",
    "course_completion_application",
    "certificate_application",
    "certificate",
    "verify"
  ];

  const LABELS = {
    dashboard: "Dashboard",
    enquiry: "Enquiry Form",
    admission: "Admission Form",
    receipt: "Receipt Form",
    batch: "Batch Form",
    batch_allocation: "Batch Allocation Form",
    attendance: "Attendance Form",
    completion: "Course Completion Form",
    student_status: "Student Information Status",
    exam: "Exam",
    exam_result: "Exam Result",
    course_completion_application: "Course Completion Application Form",
    certificate_application: "Certificate Application Form",
    certificate: "Certificate (Issue/Issued)",
    verify: "Verify Certificate"
  };

  const SUBS = {
    enquiry: "Capture new leads / enquiries",
    admission: "Register students",
    receipt: "Fee collection & receipts",
    batch: "Create batch",
    batch_allocation: "Allocate student to batch",
    attendance: "Mark sessions",
    completion: "Course completed workflow",
    student_status: "Student overview & status",
    exam: "Create exam record",
    exam_result: "Update result / score",
    course_completion_application: "Student applies for completion",
    certificate_application: "Student applies for certificate",
    certificate: "Issue / manage certificates",
    verify: "Public certificate verification"
  };

  const ICONS = {
    dashboard: "layout-dashboard",
    enquiry: "message-square",
    admission: "user-plus",
    receipt: "receipt",
    batch: "layers",
    batch_allocation: "link",
    attendance: "calendar-check",
    completion: "badge-check",
    student_status: "users",
    exam: "clipboard-check",
    exam_result: "file-check-2",
    course_completion_application: "file-text",
    certificate_application: "send",
    certificate: "award",
    verify: "shield-check"
  };

  /* ==========================================================
    Helpers
  ========================================================== */
  lucide.createIcons();
  document.getElementById("lastUpdated").textContent = new Date().toLocaleDateString();
  document.getElementById("lastUpdated2").textContent = new Date().toLocaleDateString();

  function $(id){ return document.getElementById(id); }
  function esc(s){ return String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function qs(params){ return Object.keys(params).map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k]??"")).join("&"); }

  function toggleNav(open){
    if(open) document.body.classList.add("nav-open");
    else document.body.classList.remove("nav-open");
  }

  function toast(type, title, message){
    const wrap = $("toastWrap");
    const el = document.createElement("div");
    el.className = "toast " + (type || "");
    el.innerHTML = `
      <div class="t-ico">${type==="ok" ? '<i data-lucide="check-circle"></i>' : type==="warn" ? '<i data-lucide="loader"></i>' : type==="bad" ? '<i data-lucide="x-circle"></i>' : '<i data-lucide="info"></i>'}</div>
      <div style="min-width:0">
        <b>${esc(title || "Notice")}</b>
        <p>${esc(message || "")}</p>
      </div>
      <button class="x" aria-label="Close">‚úï</button>
    `;
    el.querySelector(".x").onclick = () => el.remove();
    wrap.appendChild(el);
    lucide.createIcons();
    setTimeout(()=>{ if(el.isConnected) el.remove(); }, 4200);
  }

  function setLive(ok, text){
    const dot = $("liveDot");
    const t = $("liveText");
    dot.style.background = ok ? "#22c55e" : "#ef4444";
    dot.style.boxShadow = ok ? "0 0 0 4px rgba(34,197,94,.18)" : "0 0 0 4px rgba(239,68,68,.18)";
    t.textContent = text || (ok ? "Live" : "Offline");
  }

  function openGet(params){
    const u = new URL(WEB_APP_URL);
    Object.entries(params||{}).forEach(([k,v])=>{
      if(v!==undefined && v!==null && String(v).length) u.searchParams.set(k, v);
    });
    window.open(u.toString(), "_blank");
  }

  /* ==========================================================
    API (JSON / JSONP)
  ========================================================== */
  function apiJsonp(params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const timer = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 20000);
      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cb]; }catch(_){}
        if(script.parentNode) script.parentNode.removeChild(script);
      }
      window[cb] = (data)=>{ cleanup(); resolve(data); };

      script.src = WEB_APP_URL + "?" + qs({ ...params, callback: cb });
      script.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };
      document.head.appendChild(script);
    });
  }

  async function apiGet(params){
    if(API_MODE==="jsonp") return apiJsonp(params);
    const url = WEB_APP_URL + "?" + qs(params||{});
    const r = await fetch(url, { method:"GET", redirect:"follow" });
    const txt = await r.text();
    try { return JSON.parse(txt); } catch(e){ throw new Error("Non-JSON API response"); }
  }

  async function apiPost(params, data){
    if(API_MODE==="jsonp"){
      // JSONP can't POST ‚Üí fallback to GET payload
      return apiJsonp({ ...params, ...(data||{}) });
    }
    const url = WEB_APP_URL + "?" + qs(params||{});
    const body = new URLSearchParams();
    Object.entries(data||{}).forEach(([k,v])=> body.append(k, String(v??"")));
    const r = await fetch(url, {
      method:"POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString()
    });
    const txt = await r.text();
    try { return JSON.parse(txt); } catch(e){ throw new Error("Non-JSON API response"); }
  }

  async function callWithFallback({module, actions, method, payload}){
    let last = null;
    for(const act of actions){
      try{
        const res = method==="POST"
          ? await apiPost({module, action:act}, payload)
          : await apiGet({module, action:act, ...(payload||{})});
        if(res && res.ok) return res;
        last = res;
      }catch(e){
        last = { ok:false, error: e.message };
      }
    }
    return last || { ok:false, error:"No action succeeded" };
  }

  /* ==========================================================
    Schema (MUST exist in backend)
    Expected endpoint:
      ?module=schema&action=get   OR  ?module=<module>&action=schema
  ========================================================== */
  let APP_SCHEMA = null;

  function prettyLabel(key){
    return String(key||"")
      .replace(/_/g," ")
      .replace(/([a-z])([A-Z])/g, "$1 $2")
      .replace(/\b\w/g, ch=>ch.toUpperCase())
      .trim() || "Field";
  }

  function inferType(key){
    const k = String(key||"").toLowerCase();
    if(k.includes("date") || k.includes("dob")) return "date";
    if(k.includes("time")) return "time";
    if(k.includes("email")) return "email";
    if(k.includes("phone") || k.includes("mobile") || k.includes("whatsapp")) return "tel";
    if(k.includes("amount") || k.includes("fee") || k.includes("paid") || k.includes("balance") || k.includes("total") || k.includes("score")) return "number";
    if(k.includes("status") || k.includes("gender") || k.includes("result")) return "select";
    if(k.includes("address") || k.includes("remark") || k.includes("note") || k.includes("description")) return "textarea";
    return "text";
  }

  function normalizeSchema(resp){
    const root = resp.schema || resp.data || resp;
    if(root && root.modules && typeof root.modules==="object"){
      const out = { modules:{} };
      for(const [mid, m] of Object.entries(root.modules)){
        out.modules[mid.toLowerCase()] = normalizeModule(mid, m);
      }
      return out;
    }
    if(root && Array.isArray(root.sheets)){
      const out = { modules:{} };
      for(const s of root.sheets){
        const mid = String(s.module || s.id || s.name || "").toLowerCase() || guessModuleIdFromSheetName(s.name);
        out.modules[mid] = normalizeModule(mid, { sheet:s.name, columns:s.columns });
      }
      return out;
    }
    return null;
  }

  function normalizeModule(mid, m){
    const mod = { sheet: m.sheet || m.name || mid, pk: m.pk || m.primaryKey || null, columns: [] };
    let cols = m.columns || m.fields || m.headers || [];
    if(Array.isArray(cols) && cols.length && typeof cols[0] === "string"){
      cols = cols.map(k=>({key:k, label:prettyLabel(k), type:inferType(k), required:false, readonly:false}));
    }
    if(Array.isArray(cols)){
      mod.columns = cols.map(c=>{
        const key = String(c.key||c.name||c.header||"").trim();
        return {
          key,
          label: c.label || c.title || prettyLabel(key),
          type: c.type || inferType(key),
          required: !!c.required,
          readonly: !!c.readonly || !!c.readOnly || false,
          options: c.options || c.enum || null
        };
      }).filter(x=>x.key);
    }
    if(!mod.pk){
      const guess = mod.columns.find(c=>/id$/i.test(c.key)) || mod.columns.find(c=>/id/i.test(c.key));
      mod.pk = guess ? guess.key : (mod.columns[0]?.key || null);
    }
    // pk readonly
    mod.columns = mod.columns.map(c => (c.key===mod.pk ? {...c, readonly:true} : c));
    return mod;
  }

  function guessModuleIdFromSheetName(name){
    const n = String(name||"").toLowerCase();
    if(n.includes("enquir")) return "enquiry";
    if(n.includes("admiss")) return "admission";
    if(n.includes("receipt")) return "receipt";
    if(n.includes("batch") && n.includes("alloc")) return "batch_allocation";
    if(n.includes("batch")) return "batch";
    if(n.includes("attend")) return "attendance";
    if(n.includes("student") && n.includes("status")) return "student_status";
    if(n.includes("exam") && n.includes("result")) return "exam_result";
    if(n.includes("exam")) return "exam";
    if(n.includes("completion") && n.includes("application")) return "course_completion_application";
    if(n.includes("completion")) return "completion";
    if(n.includes("certificate") && n.includes("application")) return "certificate_application";
    if(n.includes("certificate")) return "certificate";
    if(n.includes("verify")) return "verify";
    return n.replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"").slice(0,32) || "module";
  }

  async function loadSchema(){
    const tries = [
      {module:"schema", action:"get"},
      {module:"dashboard", action:"schema"},
      {module:"health", action:"schema"},
      {module:"meta", action:"schema"}
    ];
    let last = null;
    for(const t of tries){
      try{
        const r = await apiGet(t);
        if(r && r.ok){
          const s = normalizeSchema(r);
          if(s && s.modules && Object.keys(s.modules).length) return s;
        }
        last = r;
      }catch(e){ last = { ok:false, error:e.message }; }
    }
    throw new Error(last?.error || "Schema NOT found. Backend must implement module=schema&action=get");
  }

  /* ==========================================================
    Dynamic UI (modules + schema-driven form)
  ========================================================== */
  const state = { active: "dashboard", modules: [] };

  function renderSidebar(){
    const nav = $("sideNav");
    nav.innerHTML = "";
    for(const m of state.modules){
      const b = document.createElement("button");
      b.className = "nav-item" + (m.id===state.active ? " active" : "");
      b.type = "button";
      b.dataset.mod = m.id;
      b.innerHTML = `
        <span class="nav-ico"><i data-lucide="${ICONS[m.id] || "circle"}"></i></span>
        <span class="nav-meta"><span>${esc(m.label)}</span><small>${esc(m.sub || "")}</small></span>
      `;
      b.onclick = ()=>{ state.active = m.id; renderPage(); toggleNav(false); };
      nav.appendChild(b);
    }
    lucide.createIcons();
  }

  function renderPage(){
    renderSidebar();
    const mid = state.active;
    $("activeTitle").textContent = LABELS[mid] || prettyLabel(mid);

    if(mid==="dashboard"){
      $("page").innerHTML = `
        <div class="grid">
          <div class="card">
            <h2>Dashboard</h2>
            <p class="sub">Live status & quick health. Schema-driven modules enabled.</p>
            <div class="actions">
              <button class="btn primary" type="button" onclick="openGet({module:'health',action:'ping'})"><i data-lucide="activity"></i>Open Health</button>
              <button class="btn ghost" type="button" onclick="openGet({module:'schema',action:'get'})"><i data-lucide="file-text"></i>Open Schema</button>
            </div>
            <div class="status" id="dashStatus">Status: Ready</div>
            <div class="hint">If Schema is missing: add backend endpoint <b>?module=schema&action=get</b> (returns modules+columns).</div>
          </div>

          <div class="card">
            <h2>Quick Stats</h2>
            <p class="sub">If backend supports dashboard summary, values will show.</p>
            <div class="row">
              <div>
                <label>Total Enquiries</label>
                <input id="statEnq" readonly value="‚Äî"/>
              </div>
              <div>
                <label>Admissions</label>
                <input id="statAdm" readonly value="‚Äî"/>
              </div>
              <div style="grid-column:1/-1">
                <label>Today Collection</label>
                <input id="statCol" readonly value="‚Äî"/>
              </div>
            </div>
            <div class="hint">If these remain ‚Äú‚Äî‚Äù, your dashboard module may not implement summary. It‚Äôs optional.</div>
          </div>
        </div>
      `;
      lucide.createIcons();
      // optional summary
      (async ()=>{
        const r = await callWithFallback({module:"dashboard", actions:["summary","stats","overview","home"], method:"GET", payload:{}});
        if(r && r.ok && r.data){
          $("statEnq").value = r.data.totalEnquiries ?? r.data.enquiries ?? "‚Äî";
          $("statAdm").value = r.data.totalAdmissions ?? r.data.admissions ?? "‚Äî";
          $("statCol").value = r.data.todayCollection ?? r.data.collection ?? "‚Äî";
        }
      })();
      return;
    }

    if(mid==="verify"){
      $("page").innerHTML = `
        <div class="grid">
          <div class="card">
            <h2>Verify Certificate</h2>
            <p class="sub">Verify by Certificate ID / Serial / Token (public).</p>
            <div class="row">
              <div style="grid-column:1/-1">
                <label>Certificate ID / Serial / Verify Token</label>
                <input id="v_in" placeholder="CERT00001 or SGM-CERT-... or token"/>
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" type="button" onclick="doVerify()"><i data-lucide="shield-check"></i>Verify</button>
              <button class="btn ghost" type="button" onclick="$('v_in').value=''; $('v_out').textContent='Status: Waiting';"><i data-lucide="rotate-ccw"></i>Reset</button>
            </div>
            <div class="status" id="v_out">Status: Waiting</div>
            <div class="hint">This calls backend: <b>module=verify</b> and tries actions: certificate/verify/check.</div>
          </div>
          <div class="card">
            <h2>Tip</h2>
            <p class="sub">If your verify module expects different parameter names, open the result:</p>
            <div class="actions">
              <button class="btn ghost" type="button" onclick="openGet({module:'verify',action:'certificate',certificateId: $('v_in').value})"><i data-lucide="external-link"></i>Open as certificateId</button>
              <button class="btn ghost" type="button" onclick="openGet({module:'verify',action:'certificate',certificateSerial: $('v_in').value})"><i data-lucide="external-link"></i>Open as certificateSerial</button>
              <button class="btn ghost" type="button" onclick="openGet({module:'verify',action:'certificate',verifyToken: $('v_in').value})"><i data-lucide="external-link"></i>Open as verifyToken</button>
            </div>
          </div>
        </div>
      `;
      lucide.createIcons();
      return;
    }

    // Schema-driven module form
    const mod = APP_SCHEMA?.modules?.[mid];
    if(!mod){
      $("page").innerHTML = `
        <div class="card">
          <h2>${esc(LABELS[mid] || prettyLabel(mid))}</h2>
          <p class="sub">This module is required, but schema did not include it.</p>
          <div class="status bad">Schema missing for module: ${esc(mid)}. Ensure a sheet exists for it OR mapping is correct.</div>
          <div class="hint">
            Open schema: <b>${esc(WEB_APP_URL)}?module=schema&action=get</b> and confirm module IDs returned.
          </div>
        </div>
      `;
      return;
    }

    $("page").innerHTML = renderModuleUI(mid, mod);
    lucide.createIcons();
    wireModule(mid, mod);
  }

  function renderModuleUI(mid, mod){
    const fieldsHtml = mod.columns.map(c => renderField(c, mod.pk)).join("");
    return `
      <div class="grid">
        <div class="card">
          <h2>${esc(LABELS[mid] || prettyLabel(mid))}</h2>
          <p class="sub">Fields are generated from your Google Sheet column headers. Saving sends <b>exact column keys</b>.</p>

          <form id="form_${esc(mid)}">
            <div class="row">${fieldsHtml}</div>

            <div class="actions">
              <button class="btn primary" type="button" id="saveBtn_${esc(mid)}"><i data-lucide="save"></i>Save</button>
              <button class="btn ghost" type="button" id="resetBtn_${esc(mid)}"><i data-lucide="rotate-ccw"></i>Reset</button>
              <button class="btn ghost" type="button" id="listBtn_${esc(mid)}"><i data-lucide="list"></i>Load Records</button>
              <button class="btn ghost" type="button" id="pdfBtn_${esc(mid)}"><i data-lucide="file-text"></i>PDF (by ID)</button>
            </div>

            <div class="status" id="status_${esc(mid)}">Status: Waiting</div>
            <div class="hint">
              Save tries actions: <b>save/create/upsert/add/insert/submit</b> (POST). PDF tries: <b>pdf/printpdf/generatepdf/makepdf</b> (GET).
            </div>
          </form>
        </div>

        <div class="card">
          <h2>Recent Records</h2>
          <p class="sub">Shows list if backend supports list/readAll/getAll.</p>
          <div class="row">
            <div style="grid-column:1/-1">
              <label>Search</label>
              <input id="q_${esc(mid)}" placeholder="type to search (q) and click Load Records"/>
            </div>
          </div>
          <div class="actions">
            <button class="btn ghost" type="button" id="searchBtn_${esc(mid)}"><i data-lucide="search"></i>Search</button>
            <button class="btn danger" type="button" id="clearSelBtn_${esc(mid)}"><i data-lucide="eraser"></i>Clear Selection</button>
          </div>

          <div class="tblwrap" style="margin-top:10px">
            <table class="tbl">
              <thead><tr id="thead_${esc(mid)}"><th>‚Äî</th></tr></thead>
              <tbody id="tbody_${esc(mid)}"><tr><td class="muted">No data loaded</td></tr></tbody>
            </table>
          </div>

          <div class="hint">
            Tip: click a row to load into the form. (Works if list returns objects with matching keys.)
          </div>
        </div>
      </div>
    `;
  }

  function renderField(c, pk){
    const key = c.key;
    const label = c.label || prettyLabel(key);
    const type = c.type || inferType(key);
    const ro = (c.readonly || (pk && key===pk)) ? "readonly" : "";
    const required = c.required ? "required" : "";

    // Some columns should span full width if they look like long text
    const full = (type==="textarea" || /address|remark|note|description/i.test(key)) ? `style="grid-column:1/-1"` : "";

    if(type==="textarea"){
      return `
        <div ${full}>
          <label>${esc(label)}${c.required ? " *" : ""}</label>
          <textarea name="${esc(key)}" ${required} ${ro} placeholder="${esc(label)}"></textarea>
        </div>
      `;
    }

    if(type==="select"){
      const opts = Array.isArray(c.options) ? c.options : inferSelectOptions(key);
      if(opts && opts.length){
        const optionsHtml = ['<option value="">Select</option>'].concat(opts.map(o=>`<option value="${esc(o)}">${esc(o)}</option>`)).join("");
        return `
          <div>
            <label>${esc(label)}${c.required ? " *" : ""}</label>
            <select name="${esc(key)}" ${required} ${ro}>${optionsHtml}</select>
          </div>
        `;
      }
    }

    const inputType = type==="number" ? "number" : type==="date" ? "date" : type==="time" ? "time" : type==="email" ? "email" : type==="tel" ? "tel" : "text";
    return `
      <div>
        <label>${esc(label)}${c.required ? " *" : ""}</label>
        <input type="${inputType}" name="${esc(key)}" ${required} ${ro} placeholder="${esc(label)}"/>
      </div>
    `;
  }

  function inferSelectOptions(key){
    const k = String(key||"").toLowerCase();
    if(k.includes("gender")) return ["Male","Female","Other"];
    if(k.includes("status")) return ["Active","Inactive","Pending","Completed","Cancelled","Applied","Issued","Pass","Fail"];
    if(k.includes("result")) return ["Pass","Fail"];
    if(k.includes("payment") && k.includes("mode")) return ["Cash","UPI","Card","Bank Transfer"];
    return null;
  }

  function formToObject(form){
    const payload = {};
    form.querySelectorAll("[name]").forEach(el=>{
      payload[el.name] = el.value;
    });
    return payload;
  }

  function fillForm(form, obj){
    if(!obj) return;
    form.querySelectorAll("[name]").forEach(el=>{
      if(Object.prototype.hasOwnProperty.call(obj, el.name)) el.value = obj[el.name] ?? "";
      else{
        // case-insensitive fallback
        const k = el.name.toLowerCase();
        for(const [kk,v] of Object.entries(obj)){
          if(String(kk).toLowerCase()===k){ el.value = v ?? ""; break; }
        }
      }
    });
  }

  function pickListColumns(mod){
    const cols = [];
    if(mod.pk) cols.push(mod.columns.find(c=>c.key===mod.pk)).filter(Boolean);
    const prefer = ["studentId","studentRegNo","registerNo","enquiryId","admissionId","receiptId","batchId","examId","certificateId","certificateNo","mobile","phone","name","studentName","courseId","amount","amountPaid","feeStatus","status","date","createdAt"];
    for(const k of prefer){
      const c = mod.columns.find(x=>String(x.key).toLowerCase()===k.toLowerCase());
      if(c && !cols.some(z=>z.key===c.key)) cols.push(c);
      if(cols.length>=6) break;
    }
    for(const c of mod.columns){
      if(cols.length>=6) break;
      if(!cols.some(z=>z.key===c.key)) cols.push(c);
    }
    return cols.filter(Boolean).slice(0,6);
  }

  function readAny(obj, key){
    if(obj==null) return "";
    if(Object.prototype.hasOwnProperty.call(obj, key)) return obj[key];
    const k = String(key).toLowerCase();
    for(const [kk,v] of Object.entries(obj)){
      if(String(kk).toLowerCase()===k) return v;
    }
    return "";
  }

  async function wireModule(mid, mod){
    const form = document.querySelector(`#form_${CSS.escape(mid)}`);
    const statusEl = $(`status_${mid}`);
    const saveBtn = $(`saveBtn_${mid}`);
    const resetBtn = $(`resetBtn_${mid}`);
    const listBtn = $(`listBtn_${mid}`);
    const pdfBtn = $(`pdfBtn_${mid}`);
    const searchBtn = $(`searchBtn_${mid}`);
    const clearSelBtn = $(`clearSelBtn_${mid}`);
    const qEl = $(`q_${mid}`);
    const thead = $(`thead_${mid}`);
    const tbody = $(`tbody_${mid}`);

    const cols = pickListColumns(mod);
    thead.innerHTML = cols.map(c=>`<th>${esc(c.label||prettyLabel(c.key))}</th>`).join("");

    function setStatus(kind, msg){
      statusEl.className = "status" + (kind ? (" "+kind) : "");
      statusEl.textContent = msg;
      if(kind==="warn") toast("warn", "Working‚Ä¶", msg);
      if(kind==="ok") toast("ok", "Success", msg);
      if(kind==="bad") toast("bad", "Error", msg);
    }

    resetBtn.onclick = ()=>{ form.reset(); setStatus("", "Status: Waiting"); };
    clearSelBtn.onclick = ()=>{ form.reset(); setStatus("", "Selection cleared. Status: Waiting"); };

    async function loadList(){
      const q = (qEl?.value || "").trim();
      tbody.innerHTML = `<tr><td colspan="${cols.length}">Loading‚Ä¶</td></tr>`;

      const r = await callWithFallback({
        module: mid,
        actions: ["list","readall","getall","all","index"],
        method: "GET",
        payload: q ? { q } : {}
      });

      if(!r || !r.ok){
        tbody.innerHTML = `<tr><td colspan="${cols.length}" class="muted">${esc(r?.error || "List not supported by backend")}</td></tr>`;
        return;
      }

      const rows = r.data || r.rows || r.items || [];
      if(!Array.isArray(rows) || !rows.length){
        tbody.innerHTML = `<tr><td colspan="${cols.length}" class="muted">No records</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.slice(0,50).map(row=>{
        const tds = cols.map(c=>`<td>${esc(readAny(row,c.key))}</td>`).join("");
        return `<tr style="cursor:pointer" data-row="${esc(JSON.stringify(row))}">${tds}</tr>`;
      }).join("");

      tbody.querySelectorAll("tr").forEach(tr=>{
        tr.onclick = ()=>{
          let row = {};
          try{ row = JSON.parse(tr.getAttribute("data-row")||"{}"); }catch(_){}
          fillForm(form, row);
          setStatus("ok", "Loaded from list. Edit and Save.");
        };
      });
    }

    listBtn.onclick = loadList;
    searchBtn.onclick = loadList;
    qEl.onkeydown = (e)=>{ if(e.key==="Enter"){ e.preventDefault(); loadList(); } };

    saveBtn.onclick = async ()=>{
      const payload = formToObject(form);
      setStatus("warn", "Saving‚Ä¶");

      const r = await callWithFallback({
        module: mid,
        actions: ["save","create","upsert","add","insert","submit"],
        method: (API_MODE==="jsonp" ? "GET" : "POST"),
        payload
      });

      if(!r || !r.ok){
        setLive(false, "Offline");
        return setStatus("bad", "Save failed: " + (r?.error || "Unknown error"));
      }

      setLive(true, "Live");

      // Try to display ID
      const id = r.id || r.data?.id || r.data?.[mod.pk] || r[mod.pk] || payload[mod.pk] || "";
      setStatus("ok", `Saved ‚úÖ ${id ? ("ID: " + id) : ""}`);

      // Auto-open pdf if returned
      let pdfUrl = r.pdfUrl || r.data?.pdfUrl || r.data?.url || null;
      if(pdfUrl) window.open(pdfUrl, "_blank");

      // Refresh list
      loadList().catch(()=>{});
    };

    pdfBtn.onclick = async ()=>{
      const payload = formToObject(form);
      const id = payload[mod.pk];
      if(!id){
        return setStatus("bad", `Enter/select a record first. Primary Key is: ${mod.pk || "ID"}`);
      }
      setStatus("warn", "Generating PDF‚Ä¶");
      const pr = await callWithFallback({
        module: mid,
        actions: ["pdf","printpdf","generatepdf","makepdf"],
        method: "GET",
        payload: { [mod.pk]: id, id }
      });
      if(!pr || !pr.ok) return setStatus("bad", "PDF failed: " + (pr?.error || "Not supported"));
      const pdfUrl = pr.pdfUrl || pr.data?.pdfUrl || pr.data?.url || null;
      if(pdfUrl) window.open(pdfUrl, "_blank");
      setStatus("ok", pdfUrl ? "PDF opened ‚úÖ" : "PDF generated ‚úÖ (no url returned)");
    };

    // Initial list load (optional)
    loadList().catch(()=>{});
  }

  async function doVerify(){
    const v = ($("v_in")?.value || "").trim();
    const out = $("v_out");
    if(!v){ out.className="status bad"; out.textContent="Error: Please enter certificate id/serial/token"; return; }

    out.className="status warn"; out.textContent="Verifying‚Ä¶";
    const tries = [
      { certificateId: v },
      { certificateSerial: v },
      { verifyToken: v }
    ];

    let best = null;
    for(const p of tries){
      const r = await callWithFallback({
        module: "verify",
        actions: ["certificate","verify","check"],
        method: "GET",
        payload: p
      });
      best = r;
      if(r && r.ok) break;
    }

    if(best && best.ok){
      out.className="status ok";
      out.textContent="Verified ‚úÖ (Open details in console)";
      console.log("VERIFY RESULT:", best);
      toast("ok","Verified", "Certificate verified successfully.");
    }else{
      out.className="status bad";
      out.textContent="Not found / error: " + (best?.error || "Unknown");
      toast("bad","Not Verified", best?.error || "Not found");
    }
  }

  /* ==========================================================
    Boot
  ========================================================== */
  const menuSearch = $("menuSearch");

  menuSearch.addEventListener("input", ()=>{
    const q = menuSearch.value.trim().toLowerCase();
    document.querySelectorAll("#sideNav .nav-item").forEach(btn=>{
      const text = btn.innerText.toLowerCase();
      btn.style.display = text.includes(q) ? "" : "none";
    });
  });

  (async function boot(){
    // health
    try{
      const r = await apiGet({module:"health",action:"ping"});
      if(r && (r.ok || r.status==="ok" || r.alive===true)){
        setLive(true, "Live");
        $("sysChip").textContent = "System: Live";
      }else{
        setLive(true, "Live");
        $("sysChip").textContent = "System: Live";
      }
      $("sysChip").style.opacity = "1";
    }catch(e){
      setLive(false, "Offline");
      $("sysChip").textContent = "System: Offline";
      toast("bad","API Offline", "Check WEB_APP_URL deployment/access.");
    }

    // schema
    try{
      APP_SCHEMA = await loadSchema();
      toast("ok", "Schema Loaded", "Menus + fields are now generated from sheet columns.");
    }catch(e){
      APP_SCHEMA = { modules:{} };
      toast("bad", "Schema NOT Found", "Backend must implement: ?module=schema&action=get (returns modules/columns).");
    }

    // Build modules list:
    // - Only show required modules if they exist in schema
    // - Always show Dashboard + Verify
    const schemaModules = Object.keys(APP_SCHEMA.modules || {});
    const list = [];
    list.push({id:"dashboard", label: LABELS.dashboard, sub:"Live status"});

    // Map schema module ids to our required ids if names differ:
    // (common cases: "completion_application" etc). We'll do a soft match by includes.
    function findSchemaId(requiredId){
      if(APP_SCHEMA.modules[requiredId]) return requiredId;
      const rid = requiredId.toLowerCase();
      // soft matches
      const candidates = schemaModules.filter(sid=>{
        const s = sid.toLowerCase();
        if(rid==="batch_allocation") return s.includes("alloc") && s.includes("batch");
        if(rid==="student_status") return s.includes("student") && s.includes("status");
        if(rid==="exam_result") return s.includes("exam") && s.includes("result");
        if(rid==="course_completion_application") return s.includes("completion") && s.includes("app");
        if(rid==="certificate_application") return s.includes("certificate") && s.includes("app");
        return s === rid;
      });
      return candidates[0] || null;
    }

    for(const rid of REQUIRED_ORDER){
      if(rid==="dashboard" || rid==="verify") continue;
      const sid = findSchemaId(rid);
      if(sid){
        // We will use our required id for routing UI, but bind to schema module id by alias
        // Simplest: keep sid as the module id in state so backend calls match.
        list.push({id: sid, label: LABELS[rid] || LABELS[sid] || prettyLabel(sid), sub: SUBS[rid] || SUBS[sid] || ""});
        // Ensure icon mapping for sid too
        if(!ICONS[sid] && ICONS[rid]) ICONS[sid] = ICONS[rid];
        if(!LABELS[sid] && LABELS[rid]) LABELS[sid] = LABELS[rid];
      }
    }

    // Always include verify
    list.push({id:"verify", label: LABELS.verify, sub: SUBS.verify});

    state.modules = list;

    // default active: Enquiry if exists else dashboard
    const enqId = findSchemaId("enquiry");
    state.active = enqId ? enqId : "dashboard";

    $("activeTitle").textContent = LABELS[state.active] || prettyLabel(state.active);

    // Show schema badge in sidebar chip text
    if(Object.keys(APP_SCHEMA.modules||{}).length){
      $("sysChip").textContent = "System: Live + Schema";
      $("sysChip").style.opacity = "1";
    }else{
      $("sysChip").textContent = "System: Live (Schema Missing)";
    }

    renderPage();
  })();
</script>
</body>
</html>
