<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SGM ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- React (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

  <style>
    :root{
      --sgm-navy:#0b3a6a;
      --sgm-navy-2:#124c8c;
      --sgm-bg:#f4f6f9;
      --sgm-card:#ffffff;
      --sgm-text:#0f172a;
      --sgm-muted:#64748b;
      --sgm-border:#e2e8f0;
    }
    body{ margin:0; background:var(--sgm-bg); font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--sgm-text); }
    .layout{ display:flex; min-height:100vh; }
    .sidebar{
      width:260px; background:var(--sgm-navy); color:#fff; padding:16px;
      position:fixed; top:0; bottom:0; left:0; overflow:auto;
    }
    .brand{ font-weight:700; letter-spacing:.3px; margin-bottom:12px; }
    .navlink{
      display:flex; align-items:center; gap:10px;
      color:#fff; text-decoration:none; padding:10px 10px; border-radius:8px;
      cursor:pointer; user-select:none;
    }
    .navlink:hover{ background:var(--sgm-navy-2); }
    .navlink.active{ background:rgba(255,255,255,.12); }
    .navsmall{ font-size:12px; opacity:.8; margin:4px 0 12px; }

    .main{ margin-left:260px; padding:20px; width:calc(100% - 260px); }
    .header{
      background:var(--sgm-card); border:1px solid var(--sgm-border);
      padding:16px 18px; border-radius:12px; margin-bottom:14px;
    }
    .header h4{ margin:0; }
    .header small{ color:var(--sgm-muted); }

    .card-box{
      background:var(--sgm-card); border:1px solid var(--sgm-border);
      padding:16px; border-radius:12px;
    }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .toolbar .title{ font-weight:700; }
    .table-wrap{ overflow:auto; border:1px solid var(--sgm-border); border-radius:10px; }
    table.table{ margin:0; }
    .muted{ color:var(--sgm-muted); }
    .pill{
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-size:12px; background:#eef2ff; color:#1e3a8a; border:1px solid #c7d2fe;
    }
    .btn-sgm{ background:var(--sgm-navy); color:#fff; }
    .btn-sgm:hover{ background:var(--sgm-navy-2); color:#fff; }
    .form-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
    @media (max-width: 992px){
      .sidebar{ position:static; width:100%; }
      .main{ margin-left:0; width:100%; }
      .layout{ display:block; }
      .form-grid{ grid-template-columns: 1fr; }
    }
    .required-dot{ color:#ef4444; margin-left:4px; }
    .kv{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
/** ================= CONFIG ================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbzK6xzjZg6SA5b4Br83HQiznQHCwuPvhGlM1PoP7xbQGUK0AbxYU1E4NXqtNry9lg3e/exec";

/** Sheet → module mapping (MATCHES YOUR BACKEND) */
const MODULE_MAP = {
  "Enquiries":"enquiry",
  "Courses":"courses",
  "Admissions":"admission",
  "Students":"student",
  "Receipts":"receipt",
  "Batches":"batch",
  "Attendance":"attendance",
  "Exams":"exam",
  "CourseCompletion":"completion",
  "Certificate_Applications":"certificate",
  "Certificates_Issued":"certificate"
};

function safeJson(v){ try { return JSON.stringify(v, null, 2); } catch { return String(v); } }

async function apiGet(params){
  const url = API_BASE + "?" + new URLSearchParams(params).toString();
  const r = await fetch(url, { method:"GET" });
  return await r.json();
}
async function apiPost(params, bodyObj){
  const url = API_BASE + "?" + new URLSearchParams(params).toString();
  const r = await fetch(url, { method:"POST", body: JSON.stringify(bodyObj || {}) });
  return await r.json();
}

function App(){
  const [schema, setSchema] = React.useState({});
  const [loadingSchema, setLoadingSchema] = React.useState(true);
  const [schemaError, setSchemaError] = React.useState("");

  const [activeSheet, setActiveSheet] = React.useState("");
  const [view, setView] = React.useState("home"); // home | list | form | verify
  const [rows, setRows] = React.useState([]);
  const [listLoading, setListLoading] = React.useState(false);
  const [listError, setListError] = React.useState("");

  const [searchQ, setSearchQ] = React.useState("");

  const [formData, setFormData] = React.useState({});
  const [formSaving, setFormSaving] = React.useState(false);
  const [formMsg, setFormMsg] = React.useState("");

  const [verifyInput, setVerifyInput] = React.useState("");
  const [verifyOut, setVerifyOut] = React.useState("");

  const availableSheets = React.useMemo(()=>{
    return Object.keys(schema || {})
      .filter(sh => sh !== "Counters" && MODULE_MAP[sh])
      .sort((a,b)=>a.localeCompare(b));
  }, [schema]);

  React.useEffect(()=>{
    (async()=>{
      setLoadingSchema(true);
      setSchemaError("");
      try{
        const j = await apiGet({ module:"schema", action:"get" });
        if(!j.ok) throw new Error("Schema not ok");
        setSchema(j.schema || {});
        setView("home");
      }catch(err){
        setSchemaError(String(err && err.message ? err.message : err));
      }finally{
        setLoadingSchema(false);
      }
    })();
  }, []);

  async function loadList(sheet, q=""){
    const module = MODULE_MAP[sheet];
    if(!module) return;

    setActiveSheet(sheet);
    setView("list");
    setListLoading(true);
    setListError("");
    setRows([]);
    setSearchQ(q);

    try{
      const j = q
        ? await apiGet({ module, action:"search", q })
        : await apiGet({ module, action:"list", limit: 200, offset: 0 });

      if(!j.ok) throw new Error(j.error || "Failed to load list");
      setRows(j.rows || []);
    }catch(err){
      setListError(String(err && err.message ? err.message : err));
    }finally{
      setListLoading(false);
    }
  }

  function openNewForm(sheet){
    setActiveSheet(sheet);
    setView("form");
    setFormMsg("");
    const headers = (schema?.[sheet]?.headers) || [];
    const empty = {};
    headers.forEach(h => empty[h] = "");
    setFormData(empty);
  }

  async function saveForm(){
    const sheet = activeSheet;
    const module = MODULE_MAP[sheet];
    if(!module) return;

    setFormSaving(true);
    setFormMsg("");
    try{
      const j = await apiPost({ module, action:"save" }, formData);
      if(!j.ok) throw new Error(j.error || "Save failed");
      setFormMsg("✅ Saved successfully");
      await loadList(sheet, "");
    }catch(err){
      setFormMsg("❌ " + String(err && err.message ? err.message : err));
    }finally{
      setFormSaving(false);
    }
  }

  function printPdfForRow(sheet, row){
    const module = MODULE_MAP[sheet];
    const headers = schema?.[sheet]?.headers || [];
    const pk = headers[0]; // assumes first header is PK like enquiryId, courseId, etc.
    const id = row?.[pk] || "";
    if(!id) return alert("Missing ID/PK for PDF.");
    window.open(`${API_BASE}?module=${encodeURIComponent(module)}&action=pdf&id=${encodeURIComponent(id)}`, "_blank");
  }

  function openVerify(){
    setActiveSheet("");
    setView("verify");
    setVerifyOut("");
    setVerifyInput("");
  }

  async function verifyCertificate(){
    setVerifyOut("Verifying...");
    try{
      const j = await apiGet({ module:"verify", action:"certificate", certificateId: verifyInput });
      setVerifyOut(safeJson(j));
    }catch(err){
      setVerifyOut("❌ " + String(err && err.message ? err.message : err));
    }
  }

  return (
    <div className="layout">
      <aside className="sidebar">
        <div className="brand">SGM ERP</div>
        <div className="navsmall">Corporate ERP • Web App</div>

        {loadingSchema && <div className="muted">Loading…</div>}

        {!loadingSchema && schemaError && (
          <div className="alert alert-warning p-2">
            <div className="fw-bold">Schema load failed</div>
            <div className="kv">{schemaError}</div>
          </div>
        )}

        {!loadingSchema && !schemaError && (
          <>
            {availableSheets.map(sh => (
              <div
                key={sh}
                className={"navlink " + (view !== "verify" && activeSheet === sh ? "active" : "")}
                onClick={()=>loadList(sh)}
                title={MODULE_MAP[sh]}
              >
                <span className="pill">{MODULE_MAP[sh]}</span>
                <span>{sh.replace(/_/g," ")}</span>
              </div>
            ))}

            <hr style={{borderColor:"rgba(255,255,255,.15)"}} />

            <div className={"navlink " + (view === "verify" ? "active" : "")} onClick={openVerify}>
              <span className="pill">public</span>
              <span>Verify Certificate</span>
            </div>
          </>
        )}
      </aside>

      <main className="main">
        <div className="header">
          <h4>SGM COMPUTER EDUCATION</h4>
          <small>Registered Under MSME | ISO 9001-2015 Certified Center</small>
        </div>

        <div className="card-box">
          {view === "home" && (
            <>
              <div className="d-flex align-items-center gap-2">
                <span className="fs-5">✅ ERP loaded.</span>
                <span className="muted">Select a module from the left menu.</span>
              </div>
              <div className="mt-3 muted">
                Tip: Click any module → list view → New → Save → PDF.
              </div>
            </>
          )}

          {view === "list" && (
            <>
              <div className="toolbar">
                <div className="title">{activeSheet.replace(/_/g," ")}</div>
                <div className="ms-auto d-flex gap-2 flex-wrap">
                  <input
                    className="form-control form-control-sm"
                    style={{width:240}}
                    placeholder="Search..."
                    value={searchQ}
                    onChange={(e)=>setSearchQ(e.target.value)}
                    onKeyDown={(e)=>{ if(e.key==="Enter") loadList(activeSheet, searchQ); }}
                  />
                  <button className="btn btn-outline-secondary btn-sm" onClick={()=>loadList(activeSheet, searchQ)}>Search</button>
                  <button className="btn btn-sgm btn-sm" onClick={()=>openNewForm(activeSheet)}>➕ New</button>
                  <button className="btn btn-outline-secondary btn-sm" onClick={()=>loadList(activeSheet, "")}>Refresh</button>
                </div>
              </div>

              {listLoading && <div className="muted">Loading list…</div>}
              {listError && <div className="alert alert-warning">{listError}</div>}

              {!listLoading && !listError && (
                <div className="table-wrap">
                  <table className="table table-sm table-bordered align-middle">
                    <thead className="table-light">
                      <tr>
                        {(schema?.[activeSheet]?.headers || []).map(h => <th key={h}>{h}</th>)}
                        <th style={{width:120}}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(rows || []).map((r, idx)=>(
                        <tr key={idx}>
                          {(schema?.[activeSheet]?.headers || []).map(h => <td key={h}>{String(r?.[h] ?? "")}</td>)}
                          <td>
                            <button className="btn btn-success btn-sm" onClick={()=>printPdfForRow(activeSheet, r)}>PDF</button>
                          </td>
                        </tr>
                      ))}
                      {(!rows || rows.length===0) && (
                        <tr>
                          <td colSpan={(schema?.[activeSheet]?.headers || []).length + 1} className="muted">
                            No records found.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              )}
            </>
          )}

          {view === "form" && (
            <>
              <div className="toolbar">
                <div className="title">{activeSheet.replace(/_/g," ")} Form</div>
                <div className="ms-auto d-flex gap-2">
                  <button className="btn btn-outline-secondary btn-sm" onClick={()=>loadList(activeSheet, "")}>Back</button>
                  <button className="btn btn-sgm btn-sm" disabled={formSaving} onClick={saveForm}>
                    {formSaving ? "Saving…" : "Save"}
                  </button>
                </div>
              </div>

              {formMsg && <div className={"alert " + (formMsg.startsWith("✅") ? "alert-success" : "alert-warning")}>{formMsg}</div>}

              <div className="form-grid">
                {(schema?.[activeSheet]?.headers || []).map((h)=>(
                  <div key={h}>
                    <label className="form-label">{h}</label>
                    <input
                      className="form-control"
                      value={formData?.[h] ?? ""}
                      onChange={(e)=>setFormData(prev => ({...prev, [h]: e.target.value}))}
                    />
                  </div>
                ))}
              </div>
            </>
          )}

          {view === "verify" && (
            <>
              <div className="toolbar">
                <div className="title">Verify Certificate</div>
                <div className="ms-auto">
                  <span className="pill">public</span>
                </div>
              </div>

              <div className="row g-2">
                <div className="col-lg-6">
                  <label className="form-label">Certificate ID / Token</label>
                  <input
                    className="form-control"
                    value={verifyInput}
                    onChange={(e)=>setVerifyInput(e.target.value)}
                    placeholder="CERT00001 or verifyToken…"
                  />
                </div>
                <div className="col-lg-6 d-flex align-items-end gap-2">
                  <button className="btn btn-sgm" onClick={verifyCertificate}>Verify</button>
                </div>
              </div>

              <div className="mt-3">
                <label className="form-label">Result</label>
                <pre className="p-3" style={{background:"#0b1220", color:"#d1d5db", borderRadius:10, overflow:"auto"}}>
{verifyOut || "Enter Certificate ID and click Verify."}
                </pre>
              </div>
            </>
          )}
        </div>
      </main>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
